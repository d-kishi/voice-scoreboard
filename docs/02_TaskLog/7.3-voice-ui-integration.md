# Task 7.3: 音声状態マシンとUI全体の統合

## 実装予測（Plan モードでの分析）
- App.tsx に useVoiceStateMachine を統合し、ListeningOverlay を LISTENING 状態で表示する
- ControlBar の M4 検証コードを削除し、マイク権限フローを正式統合する（requestPermissions + Alert + Linking.openSettings）
- タッチ操作時の読み上げなし・音声認識 OFF 時のフォールバックは既に実装済みと予測
- 予測変更ファイル: App.tsx, ControlBar.tsx, control-bar.test.tsx, App.test.tsx（新規）

## 実施内容
- tasks.md の Task 7.3 を実施
- Requirements: 5.1-5.5（音声コマンド操作）, 6.5（タッチ操作時読み上げなし）, 8.3-8.4（設定反映）, 9.2（オフライン動作）, 9.4（マイク権限管理）
- Contracts: ScoreScreen → useVoiceStateMachine, ControlBar → requestPermissions

## 実装結果（spec-impl の実際の出力）

### 作成/変更ファイル

| ファイル | 操作 | 役割 |
|---------|------|------|
| `App.tsx` | 変更 | useVoiceStateMachine 呼び出し + ListeningOverlay を LISTENING 状態で条件付きレンダリング |
| `src/features/score/components/ControlBar.tsx` | 変更 | M4 検証コード削除。requestPermissions + Alert + Linking.openSettings による権限フロー正式統合。isRequesting による連打防止 |
| `src/features/score/components/__tests__/control-bar.test.tsx` | 変更 | 権限テスト 4 件追加（OFF→ON 権限リクエスト、許可時 ON、拒否時 OFF + Alert、ON→OFF 権限不要）。M4 テスト行動の更新 |
| `__tests__/App.test.tsx` | 新規作成 | App 統合テスト 6 件（LISTENING 表示/非表示、カウントダウン、SPEAKING_READY/ROGER 非表示、GameEndOverlay 共存） |
| `.kiro/specs/voice-scoreboard/tasks.md` | 変更 | Task 7.3 チェックボックスを `[x]` に更新 |

### テスト結果
- `__tests__/App.test.tsx`: 6/6 PASS
- `control-bar.test.tsx`: 16/16 PASS
- 全体: 20 スイート、314 テスト PASS（リグレッションなし）

### テストケース一覧

#### App > ListeningOverlay の統合（5テスト）
| ケース | 期待値 |
|--------|--------|
| IDLE 状態では ListeningOverlay が表示されない | queryByTestId('listening-overlay') が null |
| LISTENING 状態で ListeningOverlay が表示される | getByTestId('listening-overlay') が存在 |
| LISTENING 状態でカウントダウンが正しく表示される | getByText('2s') が存在 |
| SPEAKING_READY 状態では ListeningOverlay が表示されない | queryByTestId('listening-overlay') が null |
| SPEAKING_ROGER 状態では ListeningOverlay が表示されない | queryByTestId('listening-overlay') が null |

#### App > GameEndOverlay との共存（1テスト）
| ケース | 期待値 |
|--------|--------|
| 試合終了時は GameEndOverlay が表示され ListeningOverlay は非表示 | game-end-overlay 存在、listening-overlay null |

#### ControlBar > トグルボタン（7テスト）
| ケース | 期待値 |
|--------|--------|
| 音声入力トグルボタンが表示される | testID と「音声入力」テキスト存在 |
| 読み上げトグルボタンが表示される | testID と「読み上げ」テキスト存在 |
| 音声入力トグルの OFF→ON で権限リクエストが呼ばれる | requestPermissions が呼ばれる |
| 権限が許可された場合、音声入力がONになる | isVoiceRecognitionEnabled が true |
| 権限が拒否された場合、音声入力がOFFのままでAlertが表示される | isVoiceRecognitionEnabled が false、Alert.alert 呼び出し |
| 音声入力トグルの ON→OFF では権限リクエストが呼ばれない | requestPermissions 未呼び出し、OFF に切り替わる |
| 読み上げトグルのタップで状態が切り替わる（権限リクエストなし） | selected false、requestPermissions 未呼び出し |

## 予測との比較

| 項目 | 予測 | 実際 | 乖離 |
|------|------|------|------|
| 変更ファイル | App.tsx, ControlBar.tsx, control-bar.test.tsx, App.test.tsx（新規） | 予測通り | なし |
| App.tsx 統合方式 | useVoiceStateMachine() を呼ぶだけ、start/stop 不要 | 予測通り。自己管理型で明示的な start/stop は不要 | なし |
| ControlBar M4 コード | 削除して正式な権限フローに置き換え | 予測通り。SpeechRecognitionService/SpeechSynthesisService の namespace import を削除 | なし |
| 権限 UI | Alert.alert + Linking.openSettings | 予測通り | なし |
| タッチ操作時の読み上げなし | 既に実装済み | 予測通り（useVoiceStateMachine がコマンド経由のみ読み上げ） | なし |
| 音声認識 OFF フォールバック | 既に実装済み | 予測通り（IDLE のまま認識を開始しない） | なし |
| 連打防止 | isRequesting ローカル state | 予測通り | なし |
| ToggleButton の onPress 型 | async 返り値を無視で互換 | 予測通り。型変更不要 | なし |

## 意思決定ログ

| 選択肢 | 採用 | 理由 |
|--------|------|------|
| Alert.alert vs カスタムオーバーレイ（権限拒否時） | Alert.alert | 権限ダイアログはプラットフォーム標準の見た目が適切。カスタム UI はオーバーエンジニアリング |
| handleToggleSpeech vs toggleSpeech 直接渡し | toggleSpeech 直接渡し | M4 コード削除後、読み上げトグルに追加ロジック不要。関数ラッパーは無駄 |
| ListeningOverlay visible 条件 | `voiceState === 'LISTENING'` のみ | SPEAKING_READY/ROGER 中はオーバーレイ不要。LISTENING 状態のみが仕様に合致 |

## 学び（Lessons Learned）
- useVoiceStateMachine は完全に自己管理型のため、App.tsx への統合は最小限の変更で済んだ。設計段階で hook の自律性を高めておくと統合タスクが軽量になる
- M4 検証コードを「Task 6〜7 で正式統合予定」とコメントしておいたことで、削除対象が明確でスムーズだった
- App.test.tsx の最初のテストケースが 22 秒かかるのは Jest の初期化（モジュール解決 + NativeWind CSS 処理）によるもの。2 件目以降は数十 ms で完了する

---
_completed_at: 2026-02-22_
