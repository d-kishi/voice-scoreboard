# Task 7.4 (M5): 音声UI統合のエミュレータ検証

## 実施内容
- tasks.md の Task 7.4: 音声UI統合のエミュレータ検証（M5 マイルストーン）
- Task 6.1〜7.3 の全成果物を Android エミュレータ（Pixel_7a, release ビルド）で動作検証
- Jest テスト（305件 ALL PASS）ではカバーできないネイティブ描画・音声出力・権限フローを実機相当環境で確認

## ビルド & デプロイ

| 項目 | 結果 |
|------|------|
| worklets パッチ | 適用済み（`"0.76"` in compatibility.json） |
| release ビルド | BUILD SUCCESSFUL in 11m 42s（974 tasks, 74 executed） |
| 自動インストール | 失敗（既知の WSL パス問題） |
| 手動インストール | `adb.exe install -r -d "C:\\..."` で成功 |
| アプリ起動 | `adb.exe shell am start` で正常起動 |

## 検証結果

### F. 基本動作の回帰テスト — ALL PASS

| # | 検証項目 | 結果 |
|---|---------|------|
| F1 | 横画面表示（ランドスケープ） | OK |
| F2 | スコア表示・グロー効果 | OK |
| F3 | +1/-1 ボタン動作 | OK |
| F4 | リセット確認ダイアログ | OK |
| F5 | 試合終了時 +1/-1 非表示 | OK |

### B. ホイッスル音の試合終了連携 — ALL PASS

| # | 検証項目 | 結果 |
|---|---------|------|
| B1 | タッチ操作での試合終了ホイッスル | OK |
| B2 | GameEndOverlay との同時表示 | OK |
| B3 | ホイッスル音の再生時間（約5秒） | OK |

### C. 設定トグルの反映確認 — ALL PASS

| # | 検証項目 | 結果 |
|---|---------|------|
| C1 | 音声認識 OFF→ON トグル | OK |
| C2 | 音声認識 ON→OFF トグル | OK |
| C3 | 読み上げ ON/OFF トグル | OK |
| C4 | 設定永続化（再起動テスト） | OK |

### A. LISTENING オーバーレイの表示確認 — SKIPPED（エミュレータマイク非動作）

| # | 検証項目 | 結果 |
|---|---------|------|
| A1-A6 | 全項目 | SKIP — M6（実機）に委ねる |

**logcat 確認結果**:
- `ExpoSpeechService: Start recognition` — 音声認識サービスは正常に初期化・起動
- `onError() - no-speech: No speech was detected. - code: 7` — マイク入力なし
- 自動で再起動ループ（`Start recognition` → `no-speech` → `Start recognition`）— 正しい動作
- 結論: サービス層は正常動作、エミュレータのマイクが WSL2 経由で音声を拾えない

### D. 音声コマンド E2E フロー — SKIPPED（エミュレータマイク非動作）

| # | 検証項目 | 結果 |
|---|---------|------|
| D1-D6 | 全項目 | SKIP — M6（実機）に委ねる |

### E. フォールバック確認 — ALL PASS

| # | 検証項目 | 結果 |
|---|---------|------|
| E1 | タッチ操作のみモード | OK |
| E2 | タッチ操作時に読み上げなし | OK（仕様通り） |

## 検証サマリ

| カテゴリ | 結果 | 備考 |
|---------|------|------|
| F. 基本動作回帰 | 5/5 PASS | M2 以降の回帰なし |
| B. ホイッスル音連携 | 3/3 PASS | 試合終了検出・効果音・オーバーレイ同期 |
| C. 設定トグル | 4/4 PASS | 永続化含む |
| A. LISTENING オーバーレイ | SKIP | エミュレータマイク非動作 → M6 |
| D. 音声コマンド E2E | SKIP | エミュレータマイク非動作 → M6 |
| E. フォールバック | 2/2 PASS | タッチ操作のみモード正常 |
| **合計** | **14/14 PASS + 2 SKIP** | |

## 意思決定ログ

| 選択肢 | 採用 | 理由 |
|--------|------|------|
| A/D をエミュレータで無理に検証 | 不採用 | WSL2 経由ではエミュレータマイクが動作しない（M4 で確認済み） |
| A/D を M6（実機）に委ねる | 採用 | logcat でサービス層の正常動作は確認済み。マイク入力のみが障壁 |
| release ビルド（Metro 不使用） | 採用 | WSL2 ↔ エミュレータ間の Metro 接続不安定問題の回避（M1 で確立） |

## M6 に委ねる項目

以下の項目は実機（Android）での検証が必要:
1. **LISTENING オーバーレイ**: シアンリング・マイクアイコン・Ready テキスト・カウントダウン・ディム効果・タイムアウト消去
2. **音声コマンド E2E**: ウェイクワード認識 → コマンド実行 → スコア反映の一連フロー
3. **音声での試合終了**: 音声コマンドで 25 点到達 → ホイッスル音 + オーバーレイ

## 学び（Lessons Learned）
- WSL2 エミュレータ環境では音声認識の E2E テストは不可能（M4 と同じ結論を再確認）
- logcat の `--pid` フィルタでアプリ固有のログを効率的に確認できる
- 音声認識サービスの `no-speech` → 再起動ループは正常動作パターン（エラーではない）
- release ビルドは CMake キャッシュ済みで約 12 分（Gradle キャッシュが効いている）
