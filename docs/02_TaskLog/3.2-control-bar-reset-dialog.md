# Task 3.2: 操作バーとリセット確認ダイアログ

## 実装予測（Plan モードでの分析）
- ControlBar.tsx を新規作成（左側: トグルボタン群、右側: アクションボタン群の flex-row レイアウト）
- ResetDialog.tsx を新規作成（Modal + transparent でダイアログカード表示）
- アイコンは `@expo/vector-icons` バンドル済みの Feather / Ionicons から選択
  - マイク: `Feather.mic`、スピーカー: `Ionicons.volume-high-outline`、ロールバック: `Feather.rotate-ccw`、リセット: `Feather.refresh-cw`
- トグルボタンは SettingsStore（Task 4.1）未実装のため、ローカル state でプレースホルダー実装
- ダイアログは Modal + transparent + ディム効果（expo-blur 未インストールのためブラーなし）
- ロールバック無効化は `useScore().canUndo` が false のとき `opacity-50` + `disabled`
- App.tsx で ScorePanel（flex-1）の下に配置して自然に下端固定
- リスク: `@expo/vector-icons` のテスト環境問題（transformIgnorePatterns 追加の可能性）

## 実施内容
- tasks.md 3.2「操作バーとリセット確認ダイアログ」を実施
- Requirements: 2.3（ロールバック）, 2.4（リセット確認ダイアログ）, 2.5（リセット実行）
- Contracts: ControlBar, ResetDialog

## 実装結果（spec-impl の実際の出力）

### 作成/変更ファイル
| ファイル | 操作 | 内容 |
|---------|------|------|
| `src/features/score/components/ResetDialog.tsx` | 新規作成 | リセット確認モーダルダイアログ |
| `src/features/score/components/ControlBar.tsx` | 新規作成 | 下部操作バー（トグル + ロールバック/リセット） |
| `src/features/score/components/__tests__/reset-dialog.test.tsx` | 新規作成 | ResetDialog テスト（8件） |
| `src/features/score/components/__tests__/control-bar.test.tsx` | 新規作成 | ControlBar テスト（13件） |
| `__mocks__/@expo/vector-icons.js` | 新規作成 | テスト用アイコンモック |
| `App.tsx` | 変更 | ControlBar を ScorePanel の下に配置 |
| `jest.setup.ts` | 変更なし | 既存のまま |

### 主な技術的決定
- `ResetDialog` は props（visible, onCancel, onConfirm）で制御する Presentational コンポーネント
- `ControlBar` 内部で `useState` によるダイアログ表示状態管理と `useScore` 接続を行う
- `ToggleButton` をファイル内ローカルコンポーネントとして定義（export しない）
- トグル ON/OFF は `accessibilityState.selected` で検証可能にし、テスタビリティを確保
- ロールバック無効化は `disabled` prop + `accessibilityState.disabled` + `opacity-50` の3重指定
- ダイアログの背景ディムは NativeWind の `bg-black/50` で実現

## 予測との乖離
| 項目 | 予測 | 実際 | 差異 |
|------|------|------|------|
| ControlBar 構成 | 左右 flex-row レイアウト | flex-row + justify-between | **一致** |
| アイコン選定 | Feather + Ionicons の組み合わせ | Feather（mic, rotate-ccw, refresh-cw）+ Ionicons（volume-high-outline） | **一致** |
| トグルの仮実装 | ローカル state でプレースホルダー | `useState` で仮実装 | **一致** |
| ダイアログ実装 | Modal + transparent + ディム | Modal + transparent + fade + bg-black/50 | **一致** |
| ロールバック無効化 | opacity-50 + disabled | opacity-50 + disabled + accessibilityState | **一致**（accessibilityState 追加は改善） |
| テスト環境問題 | transformIgnorePatterns 追加の可能性 | `expo-font` の `loadedNativeFonts` ネイティブ依存が原因 | **差異あり**（原因の特定は異なるが方向性は的中） |
| モックファイル | 予測なし | `__mocks__/@expo/vector-icons.js` 新規作成が必要だった | **差異あり**（予測漏れ） |

## 意思決定ログ
| 選択肢 | 採用 | 理由 |
|--------|------|------|
| アイコンモック: jest.setup.ts 内 jest.mock() vs `__mocks__/` ディレクトリ | `__mocks__/` ディレクトリ | jest.setup.ts は `.ts` 拡張子で JSX 不可。`React.createElement` 方式も `jest.mock()` のスコープ制限（`_ReactNativeCSSInterop` 変数参照禁止）で失敗。`__mocks__/` は Jest の自動モック解決で制限を回避できる |
| ToggleButton を別ファイル vs ローカル | ローカル | design.md の Contract は ControlBar のみ。ToggleButton は内部詳細であり外部公開の必要なし |
| ダイアログの背景効果: blur + dim vs dim のみ | dim のみ | `expo-blur` 未インストール。ディム効果のみで十分な視覚的分離が得られ、Task 3.2 の Requirements にブラーは必須条件ではない |
| トグル状態の検証: className vs accessibilityState | accessibilityState | NativeWind の className はテスト環境で展開されない場合がある。accessibilityState.selected は React Native テストで安定して検証可能 |
| リセット確認ダイアログの状態管理: ControlBar 内 vs 親コンポーネント | ControlBar 内 | ダイアログの表示/非表示はリセットボタンのタップに直結する関心事であり、ControlBar 内で完結させる方が凝集度が高い |

## 学び（Lessons Learned）
- `@expo/vector-icons` は `expo-font` の `loadedNativeFonts` ネイティブ API に依存しており、Jest 環境ではクラッシュする。`__mocks__/@expo/vector-icons.js` でモックが必要
- `jest.setup.ts`（`.ts` 拡張子）では JSX が使えない。`React.createElement` に書き換えても `jest.mock()` ファクトリのスコープ制限（NativeWind が挿入する `_ReactNativeCSSInterop` 変数）で失敗する。`__mocks__/` ディレクトリ方式が安全
- React Native の `Modal` は `visible={false}` のとき子要素を完全に非表示にするため、`queryByTestId` で `null` チェックが正常に機能する
- `accessibilityState` は `disabled` と `selected` の両方でテスト可能。className ベースの検証より安定している

## テスト結果
- 全 8 スイート / 118 テスト合格
- リグレッションなし
- TDD サイクル: RED → GREEN → REFACTOR 完了
