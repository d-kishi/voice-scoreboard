# Task 8.3: プラットフォーム互換性の確認

## 実施内容
- tasks.md の Task 8.3: プラットフォーム互換性の確認
  - iOS 14.0以上とAndroid 10以上での動作検証
  - Android固有の音声認識: continuous モードでのセッション維持と安定性の確認
  - マイク権限フローのプラットフォーム差異を確認
  - _Requirements: 9.4, 9.5_

## 調査結果

### 1. 最小 SDK バージョンの確認

Expo SDK 52 のデフォルト値と要件の比較:

| 設定 | Expo SDK 52 デフォルト | 要件 | 判定 |
|------|----------------------|------|------|
| Android minSdkVersion | 24 (Android 7.0) | Android 10 (API 29) | 要件より広い範囲をサポート。問題なし |
| Android targetSdkVersion | 34 | — | OK |
| Android compileSdkVersion | 35 | — | OK |
| iOS deploymentTarget | 15.1 | iOS 14.0 | iOS 15.1 以上のみサポート（iOS 14 は非対応） |

実際の設定値は `android/build.gradle` で確認:
```
minSdkVersion = Integer.parseInt(findProperty('android.minSdkVersion') ?: '24')
compileSdkVersion = Integer.parseInt(findProperty('android.compileSdkVersion') ?: '35')
targetSdkVersion = Integer.parseInt(findProperty('android.targetSdkVersion') ?: '34')
```

**結論**: app.json への明示的な設定追加は不要。iOS 14 は Expo SDK 52 でサポート対象外だが、本プロジェクトは Android 専用のため影響なし。

### 2. 依存パッケージの互換性調査

| パッケージ | バージョン | Android 10+ | iOS 15.1+ | 注意事項 |
|-----------|-----------|:-----------:|:---------:|----------|
| `expo-speech-recognition` | ^3.1.0 | 条件付き | OK | Android 12以下で `continuous: true` 非サポート |
| `expo-speech` | ~13.0.1 | OK | OK | Android は TTS エンジンの言語パック依存 |
| `expo-av` | ~15.0.2 | OK | OK | Audio API は SDK 55 で削除予定 |

#### expo-speech-recognition: Android バージョン別の機能制限

| Android バージョン | API Level | continuous モード | 備考 |
|-------------------|-----------|:-----------------:|------|
| Android 7〜12 | 24〜31 | 非サポート | wakeword 常時リスニングが動作しない |
| Android 13+ | 33+ | サポート | 句読点・フォーマット機能も利用可能 |
| Android 14+ | 34+ | サポート | 言語検出・単語レベルタイミング情報追加 |

本プロジェクトの wakeword モードは `continuous: true` を使用（`speech-recognition.ts` L157）。
Pixel 7a は Android 13+ のため実機では問題なし。Play Store 配布で Android 12 以下をサポートする場合は fallback 実装が必要。

#### expo-speech: 日本語 TTS の注意点

- Android: Google テキスト読み上げエンジンの日本語言語パックに依存。未インストール時は無音またはフォールバック
- iOS: 標準 TTS エンジンが日本語を広くサポート。サイレントモード有効時は無音になる点に注意
- Pixel 7a 実機では M5 段階で日本語読み上げ動作確認済み

#### expo-av: 将来の移行計画

- SDK 52 リリースノートで Audio/Video API が deprecated 宣言
- SDK 55 で削除予定 → `expo-audio` への移行が必要
- 現時点では対応不要

### 3. マイク権限フローのコードレビュー（Req 9.4）

| 確認ポイント | 結果 | 根拠 |
|-------------|------|------|
| 権限要求のタイミング | 適切 | `ControlBar.tsx` でトグル OFF→ON 時のみ実行 |
| 権限拒否時の Fail Fast | 正しい | Alert 表示 + `Linking.openSettings()` + 早期リターンで `toggleVoiceRecognition()` を呼ばない |
| Graceful Degradation | 正しい | タッチ操作は `useScore` hook に直接接続。音声状態マシンと独立 |
| Android/iOS 権限差異 | 吸収済み | `expo-speech-recognition` の API が差異を内部処理。プラグイン設定で両 OS の権限記述を設定 |
| テストカバレッジ | 十分 | `control-bar.test.tsx` で権限拒否・許可・既許可の 3 ケースをカバー |
| 連打防止 | 実装済み | `isRequesting` フラグで権限リクエスト中の重複呼び出しを防止 |

#### 権限フローの詳細

**サービス層** (`speech-recognition.ts`):
- `checkPermissions()`: `getPermissionsAsync()` でダイアログなしに状態確認
- `requestPermissions()`: `requestPermissionsAsync()` でシステムダイアログ表示

**UI 層** (`ControlBar.tsx` の `handleToggleVoiceRecognition()`):
1. `checkPermissions()` で許可済みか確認 → 許可済みなら `requestPermissions()` をスキップ
2. 未許可なら `requestPermissions()` を呼び出し
3. 拒否された場合は Alert + 設定画面誘導で早期リターン
4. 許可された場合のみ `toggleVoiceRecognition()` を呼び出し

**app.json の権限設定**:
- Android: `"permissions": ["RECORD_AUDIO"]`
- iOS: `"NSMicrophoneUsageDescription"` + プラグインの `"speechRecognitionPermission"` で `NSSpeechRecognitionUsageDescription` もカバー

#### 軽微な指摘

`isAvailable()`（音声認識エンジンの存在確認）が `ControlBar` や `useVoiceStateMachine` で参照されていない。エンジン自体が存在しないデバイスではトグル ON 後に無音失敗する可能性がある。ただし Req 9.4 のスコープ（権限管理）としては問題なし。将来的な改善候補として記録。

## 作成/変更ファイル

| ファイル | 操作 | 役割 |
|---------|------|------|
| `docs/02_TaskLog/8.3-platform-compatibility.md` | 作成 | 本タスクログ |

コード修正は発生せず。

## 意思決定ログ

| 選択肢 | 採用 | 理由 |
|--------|------|------|
| minSdkVersion を 29 (Android 10) に引き上げ | 不採用 | デフォルト値 24 で Android 10 以上は当然サポート。意図的に範囲を狭める必要なし |
| app.json に明示的な SDK バージョン設定を追加 | 不採用 | Expo SDK 52 のデフォルト値で要件を満たしている |
| iOS 14 サポートのため deploymentTarget を下げる | 不採用 | Expo SDK 52 が iOS 15.1 を最小要件として設定。本プロジェクトは Android 専用 |
| `isAvailable()` チェックの追加 | 不採用（将来候補） | Req 9.4 のスコープ外。Pixel 7a では問題なし。Play Store 配布時に再検討 |
| expo-av → expo-audio 移行 | 不採用（将来タスク） | SDK 55 まで猶予あり。現時点では対応不要 |

## 学び（Lessons Learned）

- Expo SDK 52 は iOS 15.1 / Android 7.0 (API 24) をデフォルト最小要件とする。要件定義の「iOS 14.0 以上」は Expo SDK のバージョンアップで自動的に iOS 15.1 以上に引き上げられた
- `expo-speech-recognition` の `continuous: true` は Android 13 (API 33) 以上でのみサポート。これは expo-speech-recognition 固有の制限ではなく、Android SpeechRecognizer API の仕様に起因する
- マイク権限フローは `checkPermissions()` → `requestPermissions()` の 2 段階構成が推奨パターン。先に状態確認することで不要なシステムダイアログ表示を回避できる
- expo-av の Audio API は SDK 55 で削除予定。将来の SDK アップグレード時に `expo-audio` への移行が必要
