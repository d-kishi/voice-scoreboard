# Task 8.2: ウェイクワード→コマンド受付のレスポンス改善

## 実装予測（Plan モードでの分析）
- SPEAKING_READY 状態を廃止し、WAKEWORD_DETECTED → 直接 LISTENING に遷移する（6状態→5状態）
- 当初仕様は「Ready を事前録音の効果音（expo-av）に変更」だったが、ユーザー意向により TTS speakReady() を維持し fire-and-forget で再生する方式に変更
- spec-impl 実行前に requirements.md / design.md / tasks.md を TTS fire-and-forget 方式に再修正
- command モードの onEnd にリカバリロジック追加（TTS が Audio Focus を奪って認識セッションが終了した場合の自動再開始）
- Ready TTS は isSpeechEnabled に関係なく常に再生（Req 8.4 変更）
- 予測変更対象: voice-types.ts, voice-state-reducer.ts, use-voice-state-machine.ts, テスト4ファイル

## 実施内容
- tasks.md の Task 8.2 (P): ウェイクワード→コマンド受付のレスポンス改善
  - SPEAKING_READY 状態廃止、WAKEWORD_DETECTED → LISTENING 直接遷移
  - Ready TTS fire-and-forget（speakReady() 維持）
  - command onEnd リカバリ（Audio Focus 競合対策）
  - _Requirements: 4.2, 6.1, 8.4, 9.2_
  - _Contracts: useVoiceStateMachine State_

## 実装結果（spec-impl の実際の出力）

### 作成/変更ファイル
| ファイル | 操作 | 役割 |
|---------|------|------|
| `src/features/voice/types/voice-types.ts` | 変更 | `'SPEAKING_READY'` を VoiceState から削除（6→5状態） |
| `src/features/voice/hooks/voice-state-reducer.ts` | 変更 | `WAKEWORD_DETECTED` → 直接 `LISTENING`。`SPEECH_READY_DONE` アクション削除、`SPEAKING_READY` 状態削除 |
| `src/features/voice/hooks/use-voice-state-machine.ts` | 変更 | `SPEAKING_READY` case 削除。`LISTENING` 進入時に `abortRecognition()` + `startCommandListening()` + `startCountdownTimer()` + `speakReady()` (fire-and-forget)。command onEnd リカバリ追加 |
| `src/features/voice/hooks/__tests__/voice-state-reducer.test.ts` | 変更 | SPEAKING_READY テスト全削除、WAKEWORD_DETECTED → LISTENING 直接遷移テスト追加、STOP allStates 更新 |
| `src/features/voice/hooks/__tests__/use-voice-state-machine.test.ts` | 変更 | SPEAKING_READY 関連テスト全削除。新規: fire-and-forget speakReady、Req 8.4、command onEnd リカバリ |
| `.kiro/specs/voice-scoreboard/requirements.md` | 変更 | Req 4.2, 6.1, 8.4 を TTS fire-and-forget 方式に修正 |
| `.kiro/specs/voice-scoreboard/design.md` | 変更 | 状態マシン図、Key Decisions、SoundService（ready 除外）、SpeechSynthesisService（Req 6.1 戻し）、Traceability 修正 |
| `.kiro/specs/voice-scoreboard/tasks.md` | 変更 | Task 8.2 を `[x]` に更新、内容を TTS fire-and-forget に修正 |

### テスト結果
- voice-state-reducer.test.ts: 31/31 PASS
- use-voice-state-machine.test.ts: 37/37 PASS
- 全体: 21 スイート、322 テスト PASS（リグレッションなし）

### テストケース一覧

#### voice-state-reducer（31テスト）

##### IDLE 状態（5テスト）
| ケース | 期待値 |
|--------|--------|
| WAKEWORD_DETECTED で LISTENING に直接遷移する | state: 'LISTENING' |
| WAKEWORD_DETECTED で countdown が LISTENING_DURATION に設定される | countdown: 5 |
| COMMAND_DETECTED を無視する | state: 'IDLE' |
| LISTENING_TIMEOUT を無視する | state: 'IDLE' |
| STOP で IDLE のまま変化しない | INITIAL_VOICE_STATE |

##### LISTENING 状態（8テスト）
| ケース | 期待値 |
|--------|--------|
| COMMAND_DETECTED で SPEAKING_ROGER に遷移する | state: 'SPEAKING_ROGER' |
| COMMAND_DETECTED で pendingCommand が設定される | pendingCommand: 'rollback' |
| COMMAND_DETECTED で countdown が 0 にクリアされる | countdown: 0 |
| COUNTDOWN_TICK で countdown が 1 減る | countdown: LISTENING_DURATION - 1 |
| LISTENING_TIMEOUT で IDLE に遷移する | INITIAL_VOICE_STATE |
| LISTENING_TIMEOUT で pendingCommand が null にクリアされる | pendingCommand: null |
| WAKEWORD_DETECTED を無視する | state: 'LISTENING' |
| STOP で IDLE に遷移する | INITIAL_VOICE_STATE |

##### SPEAKING_ROGER 状態（4テスト）
| ケース | 期待値 |
|--------|--------|
| SPEECH_ROGER_DONE で EXECUTING に遷移する | state: 'EXECUTING' |
| EXECUTING 遷移時に pendingCommand が保持される | pendingCommand: 'right' |
| WAKEWORD_DETECTED を無視する | state: 'SPEAKING_ROGER' |
| STOP で IDLE に遷移する | INITIAL_VOICE_STATE |

##### EXECUTING 状態（5テスト）
| ケース | 期待値 |
|--------|--------|
| COMMAND_EXECUTED_WITH_SCORE で SPEAKING_SCORE に遷移する（得点加算時） | state: 'SPEAKING_SCORE' |
| COMMAND_EXECUTED_WITH_SCORE で SPEAKING_SCORE に遷移する（ロールバック時） | state: 'SPEAKING_SCORE' |
| COMMAND_EXECUTED_WITH_SCORE で pendingCommand がクリアされる | pendingCommand: null |
| WAKEWORD_DETECTED を無視する | state: 'EXECUTING' |
| STOP で IDLE に遷移する | INITIAL_VOICE_STATE |

##### SPEAKING_SCORE 状態（3テスト）
| ケース | 期待値 |
|--------|--------|
| SPEECH_SCORE_DONE で IDLE に遷移する | INITIAL_VOICE_STATE |
| WAKEWORD_DETECTED を無視する | state: 'SPEAKING_SCORE' |
| STOP で IDLE に遷移する | INITIAL_VOICE_STATE |

##### STOP アクション（5テスト）
| ケース | 期待値 |
|--------|--------|
| 全5状態から IDLE に遷移する（it.each） | INITIAL_VOICE_STATE |

##### 不正なアクション（1テスト）
| ケース | 期待値 |
|--------|--------|
| 未知のアクションは現在の状態を返す | 同一オブジェクト参照 |

#### use-voice-state-machine（37テスト）

##### 初期状態（3テスト）
| ケース | 期待値 |
|--------|--------|
| 初期状態は IDLE | state: 'IDLE' |
| 初期 countdown は 0 | countdown: 0 |
| IDLE 状態でウェイクワード認識が開始される | mode: 'wakeword' |

##### ウェイクワード検知フロー（6テスト）
| ケース | 期待値 |
|--------|--------|
| ウェイクワード検知で直接 LISTENING に遷移する | state: 'LISTENING' |
| LISTENING 遷移時に countdown が LISTENING_DURATION になる | countdown: 5 |
| LISTENING 進入時に speakReady が fire-and-forget で呼ばれる | speakReady called |
| LISTENING 進入時に command モードの認識が開始される | mode: 'command' |
| speakReady の完了を待たずに command 認識が開始される | command calls > 0 |
| isSpeechEnabled=false でも speakReady が呼ばれる（Req 8.4） | speakReady called |

##### コマンド実行フロー — 得点加算（6テスト）
| ケース | 期待値 |
|--------|--------|
| 「右」検知で SPEAKING_ROGER に遷移する | state: 'SPEAKING_ROGER' |
| SPEAKING_ROGER で abortRecognition が呼ばれる（排他制御） | abortRecognition called |
| SPEAKING_ROGER で speakRoger が呼ばれる | speakRoger called |
| Roger 完了で全フロー完走（→ IDLE） | incrementScore('right'), state: 'IDLE' |
| 「左」検知で incrementScore(left) → IDLE | incrementScore('left'), state: 'IDLE' |
| interim result（isFinal=false）でもコマンドを検知する | state: 'SPEAKING_ROGER' |
| 得点加算時もスコア読み上げが行われる | speakScore called |

##### コマンド実行フロー — ロールバック/リセット（2テスト）
| ケース | 期待値 |
|--------|--------|
| 「ロールバック」→ rollback() → SPEAKING_SCORE → IDLE | rollback called, speakScore called |
| 「リセット」→ reset() → SPEAKING_SCORE → IDLE | reset called |

##### タイムアウト（3テスト）
| ケース | 期待値 |
|--------|--------|
| カウントダウンが毎秒デクリメントされる | countdown: 4, 3 |
| 5秒経過で IDLE に戻る | state: 'IDLE' |
| コマンド検知時にタイマーがキャンセルされる | state: 'SPEAKING_ROGER' |

##### 排他制御（2テスト）
| ケース | 期待値 |
|--------|--------|
| LISTENING 進入時に abortRecognition が呼ばれる | abortRecognition called |
| SPEAKING_ROGER 中は abortRecognition が呼ばれる | abortRecognition called |

##### 設定反映（4テスト）
| ケース | 期待値 |
|--------|--------|
| isVoiceRecognitionEnabled=false の場合、認識を開始しない | startRecognition not called |
| isSpeechEnabled=false でも LISTENING に遷移し speakReady が呼ばれる（Req 8.4） | speakReady called, state: 'LISTENING' |
| isSpeechEnabled=false の場合、SPEAKING_ROGER と SPEAKING_SCORE をスキップする | speakRoger/speakScore not called, state: 'IDLE' |
| isSpeechEnabled=false の場合、SPEAKING_SCORE をスキップする | speakScore not called, state: 'IDLE' |

##### stop()（3テスト）
| ケース | 期待値 |
|--------|--------|
| LISTENING 状態から IDLE に戻る | state: 'IDLE' |
| stop() で abortRecognition が呼ばれる | abortRecognition called |
| stop() で stopSpeaking が呼ばれる | stopSpeaking called |

##### wakeword セッション終了時の再開始（3テスト）
| ケース | 期待値 |
|--------|--------|
| IDLE 状態で wakeword セッションが終了すると再開始される | startRecognition +1 |
| 音声認識 OFF の場合、再開始しない | startRecognition not called |
| LISTENING 状態で終了しても再開始しない | wakeword calls unchanged |

##### command セッション終了時のリカバリ（2テスト）
| ケース | 期待値 |
|--------|--------|
| LISTENING 中に command セッションが終了すると再開始される | command calls +1 |
| SPEAKING_ROGER 中に終了しても再開始しない | command calls unchanged |

##### クリーンアップ（2テスト）
| ケース | 期待値 |
|--------|--------|
| アンマウント時に abortRecognition が呼ばれる | abortRecognition called |
| アンマウント時に stopSpeaking が呼ばれる | stopSpeaking called |

## 予測との比較
| 項目 | 予測 | 実際 | 乖離 |
|------|------|------|------|
| 方式 | TTS speakReady() fire-and-forget | TTS speakReady() fire-and-forget | なし |
| 仕様書の事前修正 | requirements.md, design.md, tasks.md の3ファイルを再修正 | 3ファイル修正済み | なし |
| VoiceState から SPEAKING_READY 削除 | voice-types.ts を変更 | voice-types.ts を変更 | なし |
| VoiceAction から SPEECH_READY_DONE 削除 | voice-state-reducer.ts を変更 | voice-state-reducer.ts を変更 | なし |
| WAKEWORD_DETECTED → LISTENING 直接遷移 | reducer で実装 | reducer で実装 | なし |
| LISTENING 進入時に speakReady fire-and-forget | hook の useEffect で実装 | hook の useEffect で実装 | なし |
| command onEnd リカバリ | LISTENING 中なら再開始 | LISTENING 中なら再開始 | なし |
| Ready TTS と isSpeechEnabled | isSpeechEnabled に関係なく常に再生 | 常に再生（Req 8.4） | なし |
| SoundService への 'ready' 追加 | 不要（TTS 方式に変更） | 不要 | なし |
| speakReady() の削除 | 削除しない（維持） | 維持 | なし |
| reducer テスト | SPEAKING_READY 削除 + 直接遷移追加 | 31テスト（-6 削除、+2 追加） | なし |
| hook テスト | SPEAKING_READY 関連削除 + 新規追加 | 37テスト（-7 削除、+7 追加） | なし |

## 意思決定ログ
| 選択肢 | 採用 | 理由 |
|--------|------|------|
| Ready を事前録音効果音（expo-av）に変更 | 不採用 | ユーザー意向により TTS 維持。アセット管理の手間を省き、既存の speakReady() をそのまま活用 |
| TTS speakReady() を fire-and-forget で再生 | 採用 | コマンド認識の開始をブロックしない。Audio Focus 競合は onEnd リカバリで対処 |
| command onEnd でリカバリ（LISTENING 中なら再開始） | 採用 | TTS が Audio Focus を奪って認識セッションが終了する可能性がある。状態チェックで安全に再開始 |
| Ready TTS を isSpeechEnabled に関係なく常に再生 | 採用 | Ready は「システムが聞いた」ことの確認応答。音声フィードバックが常に必要（Req 8.4） |
| getLastRecognitionOptionsByMode ヘルパー追加 | 採用 | LISTENING 進入時に wakeword abort → command start の順で startRecognition が呼ばれるため、モード別に options を取得する必要がある |

## 学び（Lessons Learned）
- SPEAKING_READY 状態の廃止は、reducer・hook・テストの 3 レイヤーで一貫して変更する必要があるが、reducer が純粋関数として分離されているため変更の影響範囲が明確で安全に実施できた
- TTS fire-and-forget パターンでは、Android の Audio Focus 競合で認識セッションが中断される可能性がある。onEnd コールバックで状態を確認し再開始するリカバリパターンが有効
- テストヘルパーの `getLastRecognitionOptions()` は、LISTENING 進入時の abort → start の順序で複数の startRecognition 呼び出しが発生するため、モード指定版 `getLastRecognitionOptionsByMode()` に更新する必要があった
- 仕様書の事前修正（TDD 開始前）は、spec-impl が仕様書を自律的に読み込む前に整合性を確保するために重要
