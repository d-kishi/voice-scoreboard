# Task 7.2: 試合終了時のホイッスル音連携

## 実装予測（Plan モードでの分析）
- App.tsx の M4 検証コード（useRef + useEffect）を正式な hook `useGameEndWhistle` に抽出
- isGameEnd の false → true 遷移を検知してホイッスル音を再生するロジック
- タッチ/音声の両方でカバー: isGameEnd は zustand ストア経由で変化するため同一ロジック
- SoundService 自体が Graceful Degradation を実装済みのため、呼び出し元での try-catch は除去
- 音声読み上げとの排他制御は Task 7.3 のスコープ

## 実施内容
- tasks.md の Task 7.2: 試合終了時のホイッスル音連携
  - 試合終了判定時に効果音再生サービスを呼び出してホイッスル音を5秒間再生
  - 試合終了オーバーレイとサウンド再生の同期
  - タッチ操作・音声操作の両方で試合終了時に発動することを確認
  - Requirements: 3.3, 6.6

## 実装結果（spec-impl の実際の出力）

### 作成/変更ファイル
| ファイル | 操作 | 役割 |
|---------|------|------|
| `src/features/score/hooks/use-game-end-whistle.ts` | 新規作成 | 試合終了時のホイッスル音再生を管理するカスタム hook。マウント時プリロード + isGameEnd 遷移検知 |
| `src/features/score/hooks/__tests__/use-game-end-whistle.test.ts` | 新規作成 | hook のユニットテスト（9テスト） |
| `App.tsx` | 変更 | M4 検証コード（useEffect+useRef+SoundService直接呼び出し）を削除し、`useGameEndWhistle(isGameEnd)` に置換。未使用 import を削除 |
| `.kiro/specs/voice-scoreboard/tasks.md` | 変更 | Task 7.2 を `[x]` に更新 |

### テスト結果
- スイート名: use-game-end-whistle.test.ts — 9/9 PASS
- 全体: 19 スイート、305 テスト PASS（リグレッションなし）

### テストケース一覧

#### プリロード（2テスト）
| ケース | 期待値 |
|--------|--------|
| マウント時に SoundService.preload() を呼ぶ | preload が1回呼ばれる |
| 再レンダリング時にプリロードを重複実行しない | preload は依然1回のみ |

#### ホイッスル音再生（5テスト）
| ケース | 期待値 |
|--------|--------|
| isGameEnd が false → true に遷移 | play('whistle') が1回呼ばれる |
| 初期値 false でマウント | play は呼ばれない |
| true → false → true と遷移（2試合分） | play が2回呼ばれる |
| isGameEnd が true のまま再レンダリング | play は1回のみ（重複なし） |
| isGameEnd が false → false のまま | play は呼ばれない |

#### エラーハンドリング（2テスト）
| ケース | 期待値 |
|--------|--------|
| preload が失敗 | クラッシュしない（Graceful Degradation） |
| play が失敗 | クラッシュしない（Graceful Degradation） |

## 予測との比較
| 項目 | 予測 | 実際 | 乖離 |
|------|------|------|------|
| ロジックの配置 | `useGameEndWhistle` hook に抽出 | `useGameEndWhistle` hook に抽出 | なし |
| トリガー方式 | useRef + useEffect（M4 パターンの正式化） | useRef + useEffect | なし |
| タッチ/音声両対応 | isGameEnd 監視で自動的に両方カバー | 同様 | なし |
| エラーハンドリング | SoundService 側で対応、hook の try-catch は除去 | hook 側で `.catch()` を追加（未処理 Promise rejection 防止） | 軽微な乖離: Promise の catch は必要だった |
| 変更ファイル数 | 4ファイル（新規2 + 変更2） | 4ファイル（新規2 + 変更2） | なし |

## 意思決定ログ
| 選択肢 | 採用 | 理由 |
|--------|------|------|
| ロジック配置: App.tsx 直書き vs hook 抽出 | hook 抽出 | テスタビリティ向上。renderHook で状態遷移をテスト可能。関心の分離 |
| エラーハンドリング: catch なし vs catch あり | catch あり | SoundService の Graceful Degradation に加え、hook 側でも `.catch()` で未処理 Promise rejection を防ぐ |
| preload のエラー処理 | `.catch(() => {})` | SoundService.preload() は内部で catch 済みだが、モックテストで mockRejectedValue を使うと hook 側に漏れるため明示的に catch |

## 学び（Lessons Learned）
- `useEffect` 内で非同期関数を呼ぶ場合、Promise の rejection を `.catch()` で握る必要がある。SoundService 内部が Graceful Degradation でも、テスト時の mock は内部実装をバイパスするため hook 側でも catch が必要
- M4 検証コードの `try-catch` 同期ラップは Promise rejection をキャッチしない（`SoundService.play()` は async）。`.catch()` チェーンが正しいパターン
