# Task 2.2: スコア状態管理ストアの実装

## Plan（実装前の方針）
- zustand 5.x + zundo 2.x でスコアストアを作成
- `ScoreState`: leftScore, rightScore, isGameEnd の3つの状態
- `ScoreActions`: increment/decrement（左右）, reset, setGameEnd
- zundo の `temporal` ミドルウェアで undo/redo 履歴を自動管理
- `partialize` で isGameEnd を履歴追跡から除外（スコアのみ追跡）
- 試合終了時のガード: increment/decrement を無効化、reset のみ有効
- `setGameEnd()` は useScore hook（Task 2.3）からの内部API

## 実施内容
- tasks.md の Task 2.2: スコア状態管理ストアの実装
  - zustand でスコア状態（左右の得点、試合終了フラグ）を管理するストアを作成
  - zundo（temporal middleware）でundo機能を組み込み、操作履歴を自動管理
  - 得点の加算・減算・リセット操作を提供
  - 試合終了状態ではリセット以外の操作を拒否するガード
  - テスト: 加算/減算/リセットの基本動作、試合終了時のガード、undo による状態復元

## 実装結果

### 追加パッケージ
| パッケージ | バージョン | 用途 |
|-----------|-----------|------|
| `zustand` | 5.0.11 | リアクティブ状態管理 |
| `zundo` | 2.3.0 | undo/redo ミドルウェア（zustand ^4.3.0 \|\| ^5.0.0 対応） |

### 作成ファイル
| ファイル | 役割 |
|---------|------|
| `src/stores/score-store.ts` | zustand + zundo によるスコアストア。ScoreState / ScoreActions / ScoreStore 型をエクスポート |
| `src/stores/__tests__/score-store.test.ts` | ストアのユニットテスト（27テスト） |

### 変更ファイル
| ファイル | 変更内容 |
|---------|----------|
| `package.json` | zustand, zundo を dependencies に追加 |
| `.kiro/specs/voice-scoreboard/tasks.md` | Task 2.2 を `[x]` に更新 |

### テストケース一覧

#### 初期状態（3テスト）
| ケース | 期待値 |
|--------|--------|
| leftScore | 0 |
| rightScore | 0 |
| isGameEnd | false |

#### incrementLeft（3テスト）
| ケース | 期待値 |
|--------|--------|
| 1回呼び出し | leftScore: 1 |
| 3回連続呼び出し | leftScore: 3 |
| rightScore に影響なし | rightScore: 0 |

#### incrementRight（2テスト）
| ケース | 期待値 |
|--------|--------|
| 1回呼び出し | rightScore: 1 |
| leftScore に影響なし | leftScore: 0 |

#### decrementLeft（2テスト）
| ケース | 期待値 |
|--------|--------|
| 2→1に減算 | leftScore: 1 |
| 0未満にならないガード | leftScore: 0 |

#### decrementRight（2テスト）
| ケース | 期待値 |
|--------|--------|
| 2→1に減算 | rightScore: 1 |
| 0未満にならないガード | rightScore: 0 |

#### reset（3テスト）
| ケース | 期待値 |
|--------|--------|
| 両スコアを0にリセット | leftScore: 0, rightScore: 0 |
| isGameEnd を false に | isGameEnd: false |
| zundo 履歴をクリア | pastStates.length: 0 |

#### setGameEnd（2テスト）
| ケース | 期待値 |
|--------|--------|
| true に設定 | isGameEnd: true |
| false に再設定 | isGameEnd: false |

#### 試合終了時のガード（5テスト）
| ケース | 期待値 |
|--------|--------|
| incrementLeft が無効 | スコア変化なし |
| incrementRight が無効 | スコア変化なし |
| decrementLeft が無効 | スコア変化なし |
| decrementRight が無効 | スコア変化なし |
| reset は有効 | 0-0にリセット, isGameEnd: false |

#### undo / zundo（5テスト）
| ケース | 期待値 |
|--------|--------|
| 直前の操作を取り消し | leftScore: 1→0 |
| 複数操作を順次取り消し | 正しいスナップショットに復元 |
| decrement 操作もundo | leftScore: 1→2 |
| 空履歴でundo | 状態変化なし |
| isGameEnd は履歴に含まれない | undo で leftScore のみ復元 |

### 検証結果
- `bun run test` — 63 tests passed（score-store: 27, game-rules: 30, glow-styles: 5, App: 1）✓
- `bun run typecheck` — エラー 0 ✓

## 問題点・乖離
- **zundo の参照比較問題**: `partialize` が毎回新オブジェクトを返すため、デフォルトの参照比較では `setGameEnd()` のような非スコア変更も履歴エントリとして記録されてしまった → `equality` オプションで値比較を追加して解決
- **zustand テスト時の状態リセット**: `setState(state, replace: true)` を使うとアクション関数も消える → 状態プロパティのみをマージ形式でリセットする方法に変更

## 意思決定ログ
| 選択肢 | 採用 | 理由 |
|--------|------|------|
| isGameEnd の undo 追跡 | 除外（partialize） | isGameEnd はビジネスルール判定の結果。undo 時は hook 層で再計算すべきであり、履歴に含めると不整合が発生する |
| equality オプション | 値比較を明示指定 | partialize のデフォルト参照比較では setGameEnd が不要な履歴を作成する問題を回避 |
| reset 時の履歴クリア | 自動クリア | 新しい試合の開始であり、過去の履歴を持ち越す意味がない |
| setGameEnd の公開範囲 | export（型にも含む） | useScore hook（Task 2.3）から呼び出す内部APIだが、型安全性のため ScoreActions に含める |
| decrement の下限ガード | Math.max(0, score - 1) | スコアが負の値になるのはビジネスルール上不正。サイレントに0で止める |

## 学び（Lessons Learned）
- zustand + zundo の組み合わせは zustand 5.x でも問題なく動作する（zundo 2.3.0 が ^5.0.0 をサポート）
- `partialize` を使う際は `equality` オプションも一緒に設定するのがベストプラクティス。デフォルトの参照比較は partialize と相性が悪い
- zustand のテストでは `setState` の `replace` フラグに注意。`replace: true` はアクション関数も含めて全置換するため、状態リセットにはマージ形式を使うべき
