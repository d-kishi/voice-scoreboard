# Task 2.1: 試合ルール判定の実装

## Plan（実装前の方針）
- `checkGameEnd()` と `isDeuce()` の2つの純粋関数をエクスポート
- `GameRulesConfig` 型でルールパラメータを外部注入可能に
- `DEFAULT_GAME_RULES_CONFIG` に6人制バレーボールのデフォルト値を定義
- design.md の Contract（`GameRulesService` interface）は純粋関数として実装（クラス不使用）
- TDD: 境界値テスト30件を先に書き、RED → GREEN → REFACTOR の順で実装

## 実施内容
- tasks.md の Task 2.1: 試合ルール判定の実装
  - 6人制バレーボールの試合終了判定ロジック（25点到達 + 2点差）を純粋関数として実装
  - デュース判定ロジック（24-24以降は2点差がつくまで継続）
  - ルールパラメータ（matchPoint, deuceThreshold, pointGap）を設定可能にし、将来の複数競技対応に備える
  - 境界値テスト: 25-0, 25-23, 25-24（未終了）, 24-24（デュース）, 26-24（終了）, 30-28（長デュース後の終了）等

## 実装結果

### 作成ファイル
| ファイル | 役割 |
|---------|------|
| `src/features/score/services/game-rules.ts` | `checkGameEnd()`, `isDeuce()` 純粋関数 + `GameRulesConfig` 型 + `DEFAULT_GAME_RULES_CONFIG` 定数 |
| `src/features/score/services/__tests__/game-rules.test.ts` | 境界値テスト（30テスト） |

### 変更ファイル
| ファイル | 変更内容 |
|---------|----------|
| `.kiro/specs/voice-scoreboard/tasks.md` | Task 2.1 を `[x]` に更新 |

### テストケース一覧

#### checkGameEnd（18テスト）
| カテゴリ | ケース | 期待値 |
|---------|--------|--------|
| 試合継続 | 0-0 | false |
| 試合継続 | 24-23（25点未到達） | false |
| 試合継続 | 25-24（1点差） | false |
| 試合継続 | 24-25（1点差、右側） | false |
| 試合継続 | 24-24（デュース） | false |
| 試合継続 | 29-28（デュース中、1点差） | false |
| 試合継続 | 10-10 | false |
| 試合終了 | 25-0（左側勝利） | true |
| 試合終了 | 25-23（左側勝利、2点差） | true |
| 試合終了 | 0-25（右側勝利） | true |
| 試合終了 | 26-24（デュース後） | true |
| 試合終了 | 24-26（デュース後、右側） | true |
| 試合終了 | 30-28（長デュース後） | true |
| 試合終了 | 28-30（長デュース後、右側） | true |
| カスタム | 15-0（matchPoint:15） | true |
| カスタム | 14-13（matchPoint:15） | false |
| カスタム | 21-19（matchPoint:21） | true |

#### isDeuce（11テスト）
| カテゴリ | ケース | 期待値 |
|---------|--------|--------|
| 非デュース | 0-0 | false |
| 非デュース | 24-23 | false |
| 非デュース | 23-24 | false |
| 非デュース | 10-10（閾値未到達） | false |
| デュース | 24-24 | true |
| デュース | 25-24（閾値以上、1点差） | true |
| デュース | 24-25 | true |
| デュース | 29-28 | true |
| デュース | 28-29 | true |
| デュース | 30-30 | true |
| 解消 | 26-24（2点差で終了） | false |
| 解消 | 30-28（2点差で終了） | false |

#### DEFAULT_GAME_RULES_CONFIG（1テスト）
- デフォルト値が `{ matchPoint: 25, deuceThreshold: 24, pointGap: 2 }` であること

### 検証結果
- `bun run test` — 36 tests passed（game-rules: 30, glow-styles: 5, App: 1）✓
- `bun run typecheck` — エラー 0 ✓

## 問題点・乖離
- なし。外部依存のない純粋関数のため、スムーズに実装完了。

## 意思決定ログ
| 選択肢 | 採用 | 理由 |
|--------|------|------|
| クラス vs 純粋関数 | 純粋関数 | 状態を持たない判定ロジックにクラスは不要。テスト容易性・シンプルさを優先 |
| 型定義の配置: 別ファイル vs 同居 | 同居（game-rules.ts 内） | GameRulesConfig は GameRules でのみ使用する型であり、凝集性を重視 |
| isDeuce の「解消」判定 | pointGap 以上の差がついたら false | デュースは「両者が閾値以上 かつ 差が pointGap 未満」。試合終了（差がついた）状態はデュースではない |

## 学び（Lessons Learned）
- 純粋関数 + 境界値テストの組み合わせはTDDのRED→GREENが非常に高速。外部依存がないため環境構築コストもゼロ
- WSL環境でのJest実行はWatchmanタイムアウト後のnode crawlerフォールバックで時間がかかる（初回約85秒）。キャッシュが効く2回目以降は高速化
