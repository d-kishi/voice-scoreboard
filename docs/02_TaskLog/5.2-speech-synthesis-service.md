# Task 5.2: 音声読み上げサービスの実装

## 実装予測（Plan モードでの分析）
- expo-speech のラッパーサービスを関数ベースで作成（speech-recognition.ts と同パターン）
- 予測した変更対象ファイル:
  - `src/features/voice/services/speech-synthesis.ts`（新規）
  - `src/features/voice/services/__tests__/speech-synthesis.test.ts`（新規）
  - `__mocks__/expo-speech.js`（新規）
  - `package.json`（expo-speech 依存追加）
- Contract 準拠の基本 API（speak/stop/isSpeaking）に加え、定型フレーズのヘルパー関数を追加する方針
- モック方式は `__mocks__/` ディレクトリに配置（既存の expo-speech-recognition.js と同パターン）

## 実施内容
- tasks.md の「5.2 (P) 音声読み上げサービスの実装」を実施

## 実装結果（spec-impl の実際の出力）
- 作成/変更ファイル:
  - `package.json` / `bun.lock` — expo-speech@13.0.1 追加
  - `__mocks__/expo-speech.js` — expo-speech の Jest モック（新規）
  - `src/features/voice/services/speech-synthesis.ts` — 読み上げサービス実装（新規）
  - `src/features/voice/services/__tests__/speech-synthesis.test.ts` — ユニットテスト 16件（新規）
  - `.kiro/specs/voice-scoreboard/tasks.md` — 5.2 を完了にマーク
- 主な技術的決定:
  - `speak()` で expo-speech の `onDone` と `onStopped` の両方を同じコールバックに統合。上位層（状態マシン）は終了理由を区別せず遷移可能に
  - Contract の基本 API に加え `speakReady()`, `speakRoger()`, `speakScore()` ヘルパーを追加
  - テスト結果: 16/16 PASS、全体 192 テスト PASS（リグレッションなし）

## 予測との乖離
- モックの `module.exports` に `__esModule: true` が必要だった。expo-speech は default export を使用しており、Babel の ESM 互換変換で `import Speech from 'expo-speech'` が `module.exports.default` を参照するため。expo-speech-recognition のモックはnamed export のみだったためこの問題は発生しなかった
- それ以外は予測通りの実装で完了

## 意思決定ログ
| 選択肢 | 採用 | 理由 |
|--------|------|------|
| onDone / onStopped を個別に上位層に通知 vs 統合 | 統合 | 状態マシンは終了理由を区別する必要がなく、API をシンプルに保てる |
| クラスベース vs 関数ベースのエクスポート | 関数ベース | speech-recognition.ts と統一。モジュールレベル状態が不要なため関数で十分 |
| 定型フレーズをサービス層に含める vs 状態マシン側で構築 | サービス層 | テキスト構築ロジックをカプセル化し、状態マシンの責務を軽減 |

## 学び（Lessons Learned）
- `__mocks__/` ディレクトリのモックで default export を提供する場合、`__esModule: true` が必須。named export のみのモジュール（expo-speech-recognition）では不要だが、default export を使うモジュール（expo-speech）では Babel の `_interopRequireDefault` が正しく動作するために必要
- expo-speech の `stop()` は `onStopped` コールバックを呼ぶ（`onDone` ではない）。両方をハンドリングしないと stop 時に完了通知が来ない
