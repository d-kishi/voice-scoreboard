# Task 6.1: K.I.T.T.スタイル音声状態マシンの構築

## 実装予測（Plan モードでの分析）
- useReducer + useEffect パターンで状態遷移（純粋関数）と副作用（サービス呼び出し）を分離
- 新規 4 ファイル + 3 テストファイルを作成（既存ファイルの変更なし、UI 統合は Task 7 の責務）
- コマンドパーサーを services 層に独立した純粋関数として分離
- 読み上げ OFF 時は SKIP 系アクションを設けず、通常の完了アクションを即座に dispatch
- ref パターンで useEffect コールバック内の最新値参照問題に対処
- LISTENING 状態の 3 秒カウントダウンは setInterval + useRef で管理

## 実施内容
- tasks.md の Task 6.1: K.I.T.T.スタイル音声状態マシンの構築
  - IDLE → SPEAKING_READY → LISTENING → SPEAKING_ROGER → EXECUTING → SPEAKING_SCORE → IDLE の状態遷移管理
  - 音声認識と読み上げの排他制御（読み上げ中は認識停止、完了後に再開）
  - IDLE 常時リスニング（ウェイクワード「スコア」検知 → Ready 応答）
  - LISTENING 状態の 3 秒カウントダウンとタイムアウトによる IDLE 復帰
  - コマンド（右/左/ロールバック/リセット）の判定とスコア操作の実行
  - ロールバック/リセット後のスコア読み上げ、得点加算時は Roger のみ
  - 設定（音声認識 ON/OFF、読み上げ ON/OFF）の反映
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 5.1, 5.2, 5.3, 5.4, 5.5, 6.1, 6.2, 6.3, 6.4, 6.5, 8.3, 8.4_
  - _Contracts: useVoiceStateMachine State_

## 実装結果（spec-impl の実際の出力）

### 作成/変更ファイル
| ファイル | 操作 | 役割 |
|---------|------|------|
| `src/features/voice/types/voice-types.ts` | 新規 | VoiceState, VoiceCommand 型定義 |
| `src/features/voice/services/command-parser.ts` | 新規 | 日本語テキスト → VoiceCommand 変換の純粋関数（parseCommand, isWakeword） |
| `src/features/voice/services/__tests__/command-parser.test.ts` | 新規 | コマンドパーサーのユニットテスト（17 テスト） |
| `src/features/voice/hooks/voice-state-reducer.ts` | 新規 | useReducer 用の純粋関数 reducer + VoiceReducerState / VoiceAction 型定義 |
| `src/features/voice/hooks/__tests__/voice-state-reducer.test.ts` | 新規 | reducer のユニットテスト（36 テスト） |
| `src/features/voice/hooks/use-voice-state-machine.ts` | 新規 | メイン hook。reducer + useEffect による副作用の統合 |
| `src/features/voice/hooks/__tests__/use-voice-state-machine.test.ts` | 新規 | hook の統合テスト（31 テスト） |
| `.kiro/specs/voice-scoreboard/tasks.md` | 変更 | Task 6.1 を `[x]` に更新 |

### テスト結果
- command-parser: 17/17 PASS
- voice-state-reducer: 36/36 PASS
- use-voice-state-machine: 31/31 PASS
- 全体: 17 スイート、287 テスト PASS（リグレッションなし）

### テストケース一覧

#### command-parser（17 テスト）

##### parseCommand — 完全一致（4 テスト）
| ケース | 期待値 |
|--------|--------|
| 「右」 | `'right'` |
| 「左」 | `'left'` |
| 「ロールバック」 | `'rollback'` |
| 「リセット」 | `'reset'` |

##### parseCommand — 部分一致（4 テスト）
| ケース | 期待値 |
|--------|--------|
| 「右側」 | `'right'` |
| 「左です」 | `'left'` |
| 「ロールバックして」 | `'rollback'` |
| 「リセットお願い」 | `'reset'` |

##### parseCommand — 異常系 / 優先度（3 テスト）
| ケース | 期待値 |
|--------|--------|
| 認識できないテキスト | `null` |
| 空文字列 | `null` |
| 長い語彙が優先マッチ | `'rollback'` |

##### isWakeword（6 テスト）
| ケース | 期待値 |
|--------|--------|
| 「スコア」 | `true` |
| 「スコアボード」 | `true`（部分一致） |
| 「スコアを教えて」 | `true` |
| 「すこあ」 | `false`（ひらがな不一致） |
| 空文字列 | `false` |
| 無関係なテキスト | `false` |

#### voice-state-reducer（36 テスト）

##### IDLE 状態（4 テスト）
| ケース | 期待値 |
|--------|--------|
| WAKEWORD_DETECTED | SPEAKING_READY に遷移 |
| COMMAND_DETECTED | 無視（IDLE のまま） |
| LISTENING_TIMEOUT | 無視 |
| STOP | IDLE のまま |

##### SPEAKING_READY 状態（5 テスト）
| ケース | 期待値 |
|--------|--------|
| SPEECH_READY_DONE | LISTENING に遷移 |
| countdown | LISTENING_DURATION（3）に設定 |
| WAKEWORD_DETECTED | 無視 |
| COMMAND_DETECTED | 無視 |
| STOP | IDLE に遷移 |

##### LISTENING 状態（8 テスト）
| ケース | 期待値 |
|--------|--------|
| COMMAND_DETECTED | SPEAKING_ROGER に遷移 |
| pendingCommand 設定 | コマンドが保存される |
| countdown クリア | 0 にリセット |
| COUNTDOWN_TICK | countdown - 1 |
| LISTENING_TIMEOUT | IDLE に遷移 |
| pendingCommand クリア | null |
| WAKEWORD_DETECTED | 無視 |
| STOP | IDLE に遷移 |

##### SPEAKING_ROGER 状態（4 テスト）
| ケース | 期待値 |
|--------|--------|
| SPEECH_ROGER_DONE | EXECUTING に遷移 |
| pendingCommand 保持 | コマンドが引き継がれる |
| WAKEWORD_DETECTED | 無視 |
| STOP | IDLE に遷移 |

##### EXECUTING 状態（5 テスト）
| ケース | 期待値 |
|--------|--------|
| COMMAND_EXECUTED | IDLE に遷移 |
| COMMAND_EXECUTED_WITH_SCORE | SPEAKING_SCORE に遷移 |
| pendingCommand クリア | null |
| WAKEWORD_DETECTED | 無視 |
| STOP | IDLE に遷移 |

##### SPEAKING_SCORE 状態（3 テスト）
| ケース | 期待値 |
|--------|--------|
| SPEECH_SCORE_DONE | IDLE に遷移 |
| WAKEWORD_DETECTED | 無視 |
| STOP | IDLE に遷移 |

##### STOP（全状態）+ 不正アクション（7 テスト）
| ケース | 期待値 |
|--------|--------|
| 6 状態それぞれから STOP | INITIAL_VOICE_STATE に遷移 |
| 未知のアクション | 現在の状態を返す |

#### use-voice-state-machine（31 テスト）

##### 初期状態（3 テスト）
| ケース | 期待値 |
|--------|--------|
| state | `'IDLE'` |
| countdown | `0` |
| ウェイクワード認識開始 | startRecognition(mode: wakeword) |

##### ウェイクワード検知フロー（6 テスト）
| ケース | 期待値 |
|--------|--------|
| ウェイクワード検知 | SPEAKING_READY に遷移 |
| 排他制御 | abortRecognition 呼び出し |
| Ready 読み上げ | speakReady 呼び出し |
| Ready 完了 | LISTENING に遷移 |
| countdown 初期化 | 3 |
| command 認識開始 | startRecognition(mode: command) |

##### コマンド実行（得点加算）（5 テスト）
| ケース | 期待値 |
|--------|--------|
| 「右」検知 | SPEAKING_ROGER に遷移 |
| 排他制御 | abortRecognition 呼び出し |
| Roger 読み上げ | speakRoger 呼び出し |
| Roger 完了 | incrementScore('right') → IDLE |
| 「左」検知 | incrementScore('left') |
| スコア読み上げなし | speakScore 未呼び出し |

##### コマンド実行（ロールバック/リセット）（2 テスト）
| ケース | 期待値 |
|--------|--------|
| ロールバック | rollback() → SPEAKING_SCORE → speakScore → IDLE |
| リセット | reset() → SPEAKING_SCORE → speakScore → IDLE |

##### タイムアウト（3 テスト）
| ケース | 期待値 |
|--------|--------|
| 毎秒デクリメント | 3 → 2 → 1 |
| 3 秒経過 | IDLE に戻る |
| コマンド検知でタイマーキャンセル | タイムアウトしない |

##### 排他制御（2 テスト）
| ケース | 期待値 |
|--------|--------|
| SPEAKING_READY 中 | abortRecognition 呼び出し |
| SPEAKING_ROGER 中 | abortRecognition 呼び出し |

##### 設定反映（4 テスト）
| ケース | 期待値 |
|--------|--------|
| 認識 OFF | startRecognition 未呼び出し |
| 読み上げ OFF → SPEAKING_READY | スキップして LISTENING |
| 読み上げ OFF → SPEAKING_ROGER | スキップして EXECUTING → IDLE |
| 読み上げ OFF → SPEAKING_SCORE | スキップして IDLE |

##### stop() / クリーンアップ（5 テスト）
| ケース | 期待値 |
|--------|--------|
| stop() → IDLE | state が IDLE に戻る |
| stop() → abortRecognition | 呼び出される |
| stop() → stopSpeaking | 呼び出される |
| アンマウント → abortRecognition | 呼び出される |
| アンマウント → stopSpeaking | 呼び出される |

## 予測との比較
| 項目 | 予測 | 実際 | 乖離 |
|------|------|------|------|
| ファイル構成 | 新規 4 + テスト 3 = 7 ファイル | 新規 4 + テスト 3 = 7 ファイル | なし |
| 状態管理パターン | useReducer + useEffect | useReducer + useEffect | なし |
| コマンドパーサー分離 | services 層に独立ファイル | services 層に独立ファイル | なし |
| SKIP 系アクション | 不要（通常アクションで即 dispatch） | 不要（通常アクションで即 dispatch） | なし |
| ref パターン | isSpeechEnabled, scoreRef, pendingCommandRef | 同左 + isMountedRef | isMountedRef も予測通り |
| タイマー管理 | setInterval + useRef | setInterval + useRef | なし |
| テスト数 | 未予測（テストケースのみ定義） | 84 テスト（17+36+31） | 予測以上に網羅的 |
| 既存ファイル変更 | なし | なし（tasks.md のみ） | なし |
| useEffect ループ問題 | リスクとして予測 | 発生せず（React batching で問題なし） | 予測通りリスク回避 |

## 意思決定ログ
| 選択肢 | 採用 | 理由 |
|--------|------|------|
| useReducer vs useState | useReducer | 6 状態の有限オートマトンに適合。reducer が純粋関数としてテスト可能 |
| SKIP 系アクション vs 通常アクションの即 dispatch | 通常アクション即 dispatch | reducer のアクション型を削減。pendingCommand の引き渡しが統一される |
| コマンドパーサー: 完全一致 vs 部分一致 | 部分一致（includes） | 音声認識エンジンが「右側」「右です」のようにノイズを付加する場合に対応 |
| ウェイクワード: interim vs final のみ | isFinal のみ | interim で「スコア」が出ても最終結果で別の単語に確定する可能性があるため |
| カウントダウン: setTimeout vs setInterval | setInterval | 毎秒の countdown 更新と 3 秒タイムアウトを 1 つのタイマーで管理 |
| 依存配列: `[voiceState.state]` vs `[voiceState]` | `[voiceState.state]` | countdown の変化で副作用を再実行しない（認識再起動バグの防止） |

## 学び（Lessons Learned）
- useReducer + useEffect の分離パターンは、複雑な状態マシンの TDD に非常に有効。reducer の 36 テストが全て直接関数呼び出しで書けるため、テストが高速かつ信頼性が高い
- 読み上げ OFF 時のスキップは SKIP 系の専用アクションを設けるより、通常の完了アクション（SPEECH_READY_DONE 等）を即座に dispatch する方が、reducer のロジックがシンプルになり pendingCommand の受け渡しも統一される
- Jest の fake timer (`jest.useFakeTimers()`) と renderHook + act の組み合わせでカウントダウンのテストが正確に書ける
- モック対象がモジュールレベル関数（クラスではない）の場合、`jest.mock('path')` + `as jest.MockedFunction` の組み合わせが型安全で扱いやすい
