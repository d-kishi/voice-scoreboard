# Task 5.1: 音声認識サービスの実装

## 実装予測（Plan モードでの分析）
- `expo-speech-recognition` のラッパーサービスを新規作成
- wakeword モード（自動再起動ループ）と command モード（contextualStrings）の 2 モード対応
- 変更対象: サービス本体、テスト、モック、app.json（config plugin 追加）
- 既存パターン（game-rules.ts）に倣いエクスポート関数として実装

## 実施内容
- Task 5.1 (P): SpeechRecognitionService の TDD 実装
  - Requirements: 4.1, 4.2, 5.1, 5.2, 5.3, 5.4, 9.4
  - Contract: SpeechRecognitionService Service（design.md 参照）

## 実装結果（spec-impl の実際の出力）

### 作成/変更ファイル
| ファイル | 操作 | 内容 |
|---------|------|------|
| `src/features/voice/services/speech-recognition.ts` | 新規作成 | SpeechRecognitionService 本体（startRecognition, stopRecognition, abortRecognition, isAvailable, requestPermissions） |
| `src/features/voice/services/__tests__/speech-recognition.test.ts` | 新規作成 | ユニットテスト（22 テストケース） |
| `__mocks__/expo-speech-recognition.js` | 新規作成 | ExpoSpeechRecognitionModule のモック + テストヘルパー（__emitEvent, __resetListeners） |
| `app.json` | 編集 | plugins に expo-speech-recognition を追加（microphonePermission, speechRecognitionPermission 設定） |
| `package.json` | 編集 | expo-speech-recognition@3.1.0 を依存追加（bunx expo install 経由） |
| `.kiro/specs/voice-scoreboard/tasks.md` | 編集 | Task 5.1 チェックボックスを `[x]` に更新 |

### テスト結果
- speech-recognition.test.ts: 22/22 PASS
  - wakeword モード: 7 テスト（start オプション、自動再起動ループ、stop 後の動作）
  - command モード: 4 テスト（contextualStrings、androidIntentOptions、onResult、end イベント）
  - stop / abort: 4 テスト（stop/abort 呼び出し、再起動抑止、onEnd 通知）
  - エラーハンドリング: 1 テスト
  - 権限管理: 2 テスト（許可/拒否）
  - 利用可否チェック: 2 テスト
  - リスナークリーンアップ: 2 テスト（abort 後の解除、新 start での前リスナー解除）
- 全テストスイート: 12 スイート、176/176 PASS（リグレッションなし）

### テストカバレッジ
| カテゴリ | テスト数 | 内容 |
|---------|---------|------|
| wakeword モード | 7 | start オプション確認、contextualStrings 非設定、onResult、再起動ループ、stop 後の動作 |
| command モード | 4 | contextualStrings 設定、androidIntentOptions、onResult、end イベント非再起動 |
| stop / abort | 4 | モジュール呼び出し確認、再起動抑止、onEnd 通知 |
| エラーハンドリング | 1 | error イベント → onError コールバック |
| 権限管理 | 2 | 許可/拒否の戻り値 |
| 利用可否チェック | 2 | available/unavailable |
| リスナークリーンアップ | 2 | abort 後のリスナー解除、新 start での前リスナー解除 |

## 予測との乖離
- **概ね予測通り**: ファイル構成・実装パターンは Plan モードの予測と一致
- **モックの `remove` 関数**: `__resetListeners()` で配列を削除した後に `remove()` が呼ばれると `indexOf` が undefined エラーになる問題が発生。null チェックを追加して解決
- **パッケージ名**: `expo-speech-recognition`（予測通り）。バージョンは 3.1.0（SDK 52 互換）

## 意思決定ログ
| 選択肢 | 採用 | 理由 |
|--------|------|------|
| エクスポート関数 vs クラス | エクスポート関数 | 既存パターン（game-rules.ts）に準拠。モジュールレベル状態で十分 |
| `__mocks__/` ディレクトリ方式 vs `jest.mock()` | `__mocks__/` | jest.setup.ts の JSX 制約を回避。既存パターンに準拠 |
| wakeword 再起動ループ中の onEnd 抑止 | 採用 | 上位層（useVoiceStateMachine）の誤動作防止。stop/abort 後のみ onEnd を通知 |
| abort 後のリスナー管理 | end リスナーのみ再登録 | abort 後に result イベントが来ても無視し、end のみで onEnd を通知するクリーンな設計 |
| ANDROID_SILENCE_TIMEOUT_MS = 3000 | 採用 | 発話猶予を確保。短すぎると認識が途中で止まる |

## 学び（Lessons Learned）
- `expo-speech-recognition` は `bunx expo install` で SDK 52 互換バージョン（3.1.0）が自動選択される
- モックで `__resetListeners()` を使う場合、`remove()` 内の配列参照が dangling になる可能性がある。防御的な null チェックが必要
- サービスのモジュールレベル状態（isRunning, currentOptions, subscriptions）はテスト間で共有されるため、`beforeEach` での `__resetListeners()` + `jest.clearAllMocks()` が必須
