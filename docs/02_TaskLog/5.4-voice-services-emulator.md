# Task 5.4 (M4): 音声サービスのエミュレータ検証

## 実装予測（Plan モードでの分析）
- TTS（expo-speech）: エミュレータ内蔵 TTS エンジンで日本語発話が可能
- 効果音（expo-av）: ファイル再生は部分的にサポート。動作しない場合は M6 で確認
- 音声認識（expo-speech-recognition）: エミュレータでは不安定。権限フロー確認のみ
- ブロッカー: `assets/sounds/whistle.wav` 未配置、テスト用トリガーコードが必要

## 実施内容
- Task 5.4: 音声サービスのエミュレータ検証（M4 マイルストーン）
  - TTS、効果音、音声認識の 3 サービスをエミュレータ上で動作確認
  - テスト用トリガーを ControlBar / App.tsx に追加（Task 6〜7 で正式統合予定）

## 実装結果

### 作成/変更ファイル
| ファイル | 操作 | 内容 |
|---------|------|------|
| `assets/sounds/whistle.wav` | 新規作成 | Python `wave` モジュールで生成（2800Hz + 3200Hz ビブラート、5秒、44.1kHz 16-bit mono） |
| `src/features/voice/services/sound.ts` | 編集 | require パス修正: `../../../../../` → `../../../../`、拡張子 `.mp3` → `.wav` |
| `src/features/voice/services/speech-synthesis.ts` | 編集 | `import Speech from 'expo-speech'` → `import * as Speech from 'expo-speech'`（default export 不在バグ修正） |
| `__mocks__/expo-speech.js` | 編集 | `import * as Speech` に対応するモック構造に変更 |
| `src/features/score/components/ControlBar.tsx` | 編集 | M4 テスト用トリガー追加（TTS speakReady、音声認識 requestPermissions） |
| `App.tsx` | 編集 | M4 テスト用トリガー追加（SoundService preload/play）、ErrorBoundary 追加 |
| `__mocks__/audio-file.js` | 新規作成 | `.wav` ファイルの Jest モック |

### 検証結果
| 検証項目 | 結果 | 備考 |
|----------|------|------|
| **TTS (expo-speech)** | ✅ | 「読み上げ」トグル ON で「Ready」発話確認。Google TTS エンジン (com.google.android.tts) で動作 |
| **効果音 (expo-av)** | ✅ | 試合終了（25点到達）でホイッスル音再生確認 |
| **音声認識 権限要求** | ✅ | 「音声入力」トグル ON でマイク権限ダイアログ表示、許可成功 |
| **音声認識 認識テスト** | ⏭️ M6 | エミュレータでの認識精度テストは M6（実機）に委ねる |

### バグ修正
| バグ | 原因 | 修正 |
|------|------|------|
| 「読み上げ」トグル ON でブラックアウト | `expo-speech` は default export を持たないが `import Speech from 'expo-speech'` としていたため `Speech` が `undefined` | `import * as Speech from 'expo-speech'` に変更 |
| Metro が whistle.wav を解決できない | require パスの `../` が 5 階層だが実際は 4 階層 | `'../../../../assets/sounds/whistle.wav'` に修正 |

### テスト結果
- 全体: 14 スイート、203 テスト PASS（リグレッションなし）

## 予測との比較
| 項目 | 予測 | 実際 | 乖離 |
|------|------|------|------|
| TTS | エミュレータ TTS エンジンで動作 | Google TTS で動作。ただし import バグで初回ブラックアウト | **import 形式のバグ** |
| 効果音 | 部分的サポート、動作しない場合も | 正常に再生された | **予測より良好** |
| 音声認識 | エミュレータでは不安定。権限フロー確認のみ | 権限フロー確認完了。認識テストは M6 | 予測通り |
| whistle ファイル | ffmpeg で生成 | ffmpeg 未インストール。Python wave モジュールで代替 | **生成方法の変更** |
| sound.ts require パス | 正常 | 5 階層の `../` が誤り（4 階層が正しい） | **パスバグ発見** |

## 意思決定ログ
| 選択肢 | 採用 | 理由 |
|--------|------|------|
| whistle 生成: ffmpeg vs Python | Python | ffmpeg が WSL2 に未インストール、sudo 不可。Python の wave モジュールで同等品を生成 |
| ErrorBoundary 追加 | 追加 | release ビルドでは Red Box がないためクラッシュ原因が不明。M4 デバッグ用に残す |
| テストトリガーの配置場所 | ControlBar + App.tsx | 既存 UI（トグルボタン、試合終了）に最小限のコードを追加。Task 6〜7 で正式統合時に置き換え |
| ブラックアウト調査: ErrorBoundary vs logcat | 両方 | ErrorBoundary は JS エラー、logcat はネイティブエラーをキャプチャ。結果的に logcat で `TypeError: Cannot read property 'speak' of undefined` を発見 |

## 学び（Lessons Learned）
- `expo-speech` は **named exports のみ** で default export がない。`import * as Speech from 'expo-speech'` が正しい
- Jest モックで `__esModule: true` + `default: Speech` を設定するとテストでは default import が通ってしまい、実行時バグを隠蔽する
- release ビルドのデバッグには ErrorBoundary + logcat の併用が有効。logcat は `adb.exe logcat -d | grep ReactNativeJS` でフィルタリング
- `require()` のパス深度は Jest モック環境では検証されない。ネイティブビルドで初めてエラーになる
- Android エミュレータの Google TTS エンジン（com.google.android.tts）は日本語を含む多言語 TTS をサポートしている
