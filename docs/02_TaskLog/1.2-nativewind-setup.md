# Task 1.2: NativeWind（Tailwind CSS）の導入とデザイントークン定義

## Plan（実装前の方針）
- NativeWind v4（4.2.x）+ Tailwind CSS v3（^3.4.17）を採用
- babel.config.js に `jsxImportSource: "nativewind"` + `nativewind/babel` プリセット
- metro.config.js に `withNativeWind()` ラッパー
- design.md のカラーパレット（9色）を tailwind.config.js のデザイントークンとして定義
- グロー効果は textShadow ベースの共通ユーティリティ（NativeWind 非対応のため style prop 併用）
- TDD: グロー効果ユーティリティをテストファースト、設定ファイルは構成変更

## 実施内容
- tasks.md の Task 1.2: NativeWind（Tailwind CSS）の導入とデザイントークン定義
  - NativeWind v4 のインストールと metro.config.js / babel.config.js / global.css の作成
  - tailwind.config.js でビジュアルデザイン仕様のカラーパレットをテーマカラーとして定義
  - ダークモード背景をデフォルトに設定
  - グロー効果（textShadow）用の共通スタイルユーティリティを用意
  - 動作確認用のサンプル画面でスタイリングが適用されることを検証

## 実装結果

### 作成ファイル
| ファイル | 役割 |
|---------|------|
| `tailwind.config.js` | Tailwind CSS 設定 + nativewind/preset + デザイントークン（9色） |
| `global.css` | Tailwind ディレクティブ（@tailwind base/components/utilities） |
| `nativewind-env.d.ts` | NativeWind TypeScript 型定義（className prop の型サポート） |
| `src/utils/glow-styles.ts` | textShadow によるグロー効果の共通スタイルユーティリティ（white/cyan/gold） |
| `src/utils/__tests__/glow-styles.test.ts` | グローユーティリティのテスト（5テスト） |
| `__mocks__/css.js` | Jest 用 CSS モジュールモック |

### 変更ファイル
| ファイル | 変更内容 |
|---------|----------|
| `babel.config.js` | `jsxImportSource: "nativewind"` + `nativewind/babel` プリセット追加 |
| `metro.config.js` | `withNativeWind()` ラッパー適用（input: `./global.css`） |
| `tsconfig.json` | `nativewind-env.d.ts` を include に追加 |
| `package.json` | 依存追加、Jest に `moduleNameMapper`（@/ エイリアス + CSS モック）追加、`transformIgnorePatterns` に nativewind/react-native-css-interop 追加 |
| `App.tsx` | `import "./global.css"` 追加、StyleSheet → className ベースに変換、glowStyles.white 適用 |

### 依存関係（追加分）
- **ランタイム**: nativewind@4.2.1, react-native-reanimated@3.16.7, react-native-safe-area-context@4.12.0
- **開発**: tailwindcss@3.4.19

### デザイントークン（tailwind.config.js）
| Tailwind キー | 値 | 用途 |
|---|---|---|
| `background` | `#0f172a` | ダークネイビー背景 |
| `score` | `#ffffff` | スコア数字（白） |
| `accent-cyan` | `#00e5ff` | シアン（LISTENING系） |
| `accent-gold` | `#f59e0b` | ゴールド/アンバー（試合終了系） |
| `danger` | `#ef4444` | 危険操作（赤） |
| `btn` | `#334155` | ボタン背景（ダークグレー） |
| `btn-border` | `#475569` | ボタンボーダー（グレー） |
| `toggle-active` | `#06b6d4` | トグル有効時（シアン） |
| `bar` | `#1e293b` | 下部バー背景 |

### 検証結果
- `bun run test` — 6 tests passed（glow-styles: 5, App: 1）✓
- `bun run typecheck` — エラー 0 ✓
- `bun run lint` — エラー 0 ✓

## 問題点・乖離
- react-native-reanimated / safe-area-context のバージョン不一致
  - **事象**: `bun add` で最新版がインストールされた
    - reanimated 4.2.1、safe-area-context 5.6.2
  - **検出**: `bunx expo install --check` で Expo SDK 52 の動作保証バージョンとの不一致を検出
  - **原因**: Expo SDK はバージョンごとにネイティブパッケージのテスト済み組み合わせを定めている。
    メジャーバージョン違い（reanimated 4.x vs 3.x）はネイティブ API の非互換でビルド失敗のリスクがある
  - **対応**: `bunx expo install` で SDK 52 対応版に修正
    - reanimated 4.2.1 → 3.16.7
    - safe-area-context 5.6.2 → 4.12.0
- NativeWind v4 の peer dependency 警告
  - **事象**: インストール時に `tailwindcss@4.1.18` を要求する警告が表示された
  - **原因**: nativewind の peerDep 範囲が `>3.3.0` のため Tailwind v4 も含んでしまう
  - **対応**: NativeWind v4 は Tailwind v3 系が必須。`tailwindcss@^3.4.17` を明示インストールし正常動作を確認
- Jest で CSS import と `@/` パスエイリアスが未解決
  - **事象**: `import "./global.css"` と `import { ... } from '@/utils/...'` が Jest 環境で解決できない
  - **原因**: Metro bundler 用の設定は Jest に反映されない
  - **対応**: `moduleNameMapper` で `@/` → `src/` のエイリアスと CSS モック（`__mocks__/css.js`）を追加

## 意思決定ログ
| 選択肢 | 採用 | 理由 |
|--------|------|------|
| NativeWind v4 vs v5 | v4（4.2.1） | v5 はプレリリース。design.md で v4 を明記 |
| Tailwind CSS v3 vs v4 | v3（3.4.19） | NativeWind v4 は Tailwind v3 系が必須 |
| グロー効果: NativeWind vs style prop | style prop | NativeWind は textShadow 未サポート。style 併用が必要 |
| CSS モック方式 | moduleNameMapper + 空モジュール | Jest 標準的なアプローチ。シンプルで確実 |

## 学び（Lessons Learned）
- NativeWind 4.x の peer dependency 警告は `>3.3.0` が原因。Tailwind v3 を明示インストールすれば問題なし
- ネイティブパッケージは `bun add` ではなく `bunx expo install <pkg>` でインストールすること。SDK 互換バージョンが自動選択される。`bun add` は最新版を取得するため SDK との不一致が起きやすい
- Jest 環境では CSS ファイルモック + パスエイリアス設定が必要（NativeWind 公式ドキュメントには記載なし）
- `nativewind-env.d.ts` のファイル名は `nativewind.d.ts` と違う名前にする必要がある（公式ドキュメント注記）
