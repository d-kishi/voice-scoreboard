# Task 4.1: 設定ストアと永続化

## Plan（実装前の方針）
- zustand 5.x の `persist` ミドルウェアで音声認識 ON/OFF、読み上げ ON/OFF の設定を管理
- `SettingsState`: isVoiceRecognitionEnabled, isSpeechEnabled の2つの設定
- `SettingsActions`: toggleVoiceRecognition(), toggleSpeech()
- `createJSONStorage(() => AsyncStorage)` で AsyncStorage をバックエンドに使用
- ハイドレーション（復元）完了は `persist.hasHydrated()` + `onFinishHydration()` で検知
- useSettings hook で SettingsStore と UI を仲介（useScore と同じパターン）
- ControlBar のローカル useState プレースホルダーを useSettings に差し替え
- AsyncStorage モックは `__mocks__/` ディレクトリ方式（jest.setup.ts の scope 問題回避）

## 実施内容
- tasks.md の Task 4.1: 設定ストアと永続化
  - zustand + persist ミドルウェアで音声認識ON/OFF、読み上げON/OFFの設定を管理
  - AsyncStorage による永続化で次回起動時に設定を復元
  - ハイドレーション完了を検知し、設定復元後にアプリを初期化
  - テスト: 設定変更の永続化、アプリ再起動時の復元

## 実装結果

### 追加パッケージ
| パッケージ | バージョン | 用途 |
|-----------|-----------|------|
| `@react-native-async-storage/async-storage` | 未インストール（モックで動作） | 設定の永続化。ネイティブビルド前に `bunx expo install` が必要 |

### 作成ファイル
| ファイル | 役割 |
|---------|------|
| `src/stores/settings-store.ts` | zustand + persist による設定ストア。SettingsState / SettingsActions / SettingsStore 型をエクスポート |
| `src/stores/__tests__/settings-store.test.ts` | ストアのユニット + 永続化テスト（13テスト） |
| `src/features/settings/hooks/use-settings.ts` | 設定 hook（UseCase 層）。ハイドレーション状態を含む UseSettingsReturn を公開 |
| `src/features/settings/hooks/__tests__/use-settings.test.ts` | hook テスト（9テスト） |
| `__mocks__/@react-native-async-storage/async-storage.js` | AsyncStorage のインメモリ Jest モック（`__resetStore` ヘルパー付き） |

### 変更ファイル
| ファイル | 変更内容 |
|---------|----------|
| `src/features/score/components/ControlBar.tsx` | ローカル useState を useSettings hook に差し替え。JSDoc コメント更新 |
| `src/features/score/components/__tests__/control-bar.test.tsx` | beforeEach に SettingsStore リセットを追加 |
| `.kiro/specs/voice-scoreboard/tasks.md` | Task 4.1 を `[x]` に更新 |

### テストケース一覧

#### SettingsStore テスト（13テスト）

##### 初期状態（2テスト）
| ケース | 期待値 |
|--------|--------|
| isVoiceRecognitionEnabled | true |
| isSpeechEnabled | true |

##### toggleVoiceRecognition（3テスト）
| ケース | 期待値 |
|--------|--------|
| true → false | isVoiceRecognitionEnabled: false |
| false → true | isVoiceRecognitionEnabled: true |
| isSpeechEnabled に影響なし | isSpeechEnabled: true |

##### toggleSpeech（3テスト）
| ケース | 期待値 |
|--------|--------|
| true → false | isSpeechEnabled: false |
| false → true | isSpeechEnabled: true |
| isVoiceRecognitionEnabled に影響なし | isVoiceRecognitionEnabled: true |

##### 永続化（3テスト）
| ケース | 期待値 |
|--------|--------|
| 設定変更が AsyncStorage に保存される | setItem が正しいキー・値で呼ばれる |
| AsyncStorage から設定が復元される | リハイドレーション後に false, false が復元 |
| AsyncStorage が空の場合 | デフォルト値 true, true が使用される |

##### ハイドレーション（2テスト）
| ケース | 期待値 |
|--------|--------|
| hasHydrated() | ハイドレーション完了後に true |
| onFinishHydration コールバック | コールバックが呼ばれる |

#### useSettings hook テスト（9テスト）

##### 初期状態（3テスト）
| ケース | 期待値 |
|--------|--------|
| isVoiceRecognitionEnabled | true |
| isSpeechEnabled | true |
| hasHydrated | boolean 型で返す |

##### toggleVoiceRecognition（2テスト）
| ケース | 期待値 |
|--------|--------|
| 1回トグル | false |
| 連続トグル | true に戻る |

##### toggleSpeech（2テスト）
| ケース | 期待値 |
|--------|--------|
| 1回トグル | false |
| 連続トグル | true に戻る |

##### 独立性（2テスト）
| ケース | 期待値 |
|--------|--------|
| toggleVoiceRecognition は isSpeechEnabled に影響しない | true のまま |
| toggleSpeech は isVoiceRecognitionEnabled に影響しない | true のまま |

### 検証結果
- `npx jest` — 154 tests passed（settings-store: 13, use-settings: 9, 既存: 132）✓
- リグレッション: なし ✓

## 問題点・乖離
- **zustand persist のレースコンディション**: `setState()` が persist ミドルウェアの非同期書き込みをトリガーするため、テストで AsyncStorage を直接操作する際に競合が発生した → `beforeEach` を async にして書き込み完了を 50ms 待機後に `__resetStore` を呼ぶことで解決
- **rehydrate() のタイミング**: `await rehydrate()` だけでは状態更新が完了しない場合がある → `onFinishHydration` コールバックを Promise でラップして確実に完了を待つパターンを採用
- **AsyncStorage パッケージ未インストール**: テストはモックで全て通過するが、ネイティブビルド時に `bunx expo install @react-native-async-storage/async-storage` が必要

## 予測との比較
| 項目 | 予測 | 実際 | 乖離 |
|------|------|------|------|
| ファイル構成 | 8ファイル（作成5 + 変更3） | 8ファイル（作成5 + 変更3） | なし |
| デフォルト値 | 両方 true | 両方 true | なし |
| AsyncStorage キー | `'voice-scoreboard-settings'` | `'voice-scoreboard-settings'` | なし |
| ハイドレーション | useState + onFinishHydration | useState + onFinishHydration | なし |
| persist レースコンディション | リスクとして予測 | 実際に発生し対処 | 予測通り |
| App.tsx ローディングゲート | 不要（Task 7.3 まで延期） | 追加せず | なし |

## 意思決定ログ
| 選択肢 | 採用 | 理由 |
|--------|------|------|
| AsyncStorage モック方式 | `__mocks__/` ディレクトリ | jest.setup.ts の NativeWind scope 問題を回避。`__resetStore` ヘルパーでテスト間の独立性を確保 |
| ハイドレーション検知方式 | useState + onFinishHydration | useSyncExternalStore は zustand persist の API パターンに合わない。useState + useEffect が自然 |
| persist version | 1 | 将来の設定項目追加時にマイグレーションを可能にする |
| useSettings hook の必要性 | 作成する（薄いラッパー） | useScore と同じ仲介パターンを維持。Task 6.1 の useVoiceStateMachine が参照する公開 API として確立 |
| App.tsx ローディングゲート | 追加しない | デフォルト値 = 望ましい初期値。ハイドレーション遅延の影響なし。Task 7.3 で必要なら追加 |

## 学び（Lessons Learned）
- zustand persist ミドルウェアの `setState()` は非同期で AsyncStorage に書き込むため、テストでは書き込み完了を待つ必要がある（50ms setTimeout で対処可能）
- `rehydrate()` の Promise 解決は状態更新完了を保証しない場合がある。`onFinishHydration` コールバックが最も確実な完了検知方法
- `__mocks__/` ディレクトリによるスコープドパッケージのモック（`@react-native-async-storage/async-storage`）は、`@expo/vector-icons` と同様に正しく解決される
- zustand persist + AsyncStorage モックの組み合わせでは、テストの状態リセット順序が重要: setState → 書き込み待機 → AsyncStorage リセット の順
