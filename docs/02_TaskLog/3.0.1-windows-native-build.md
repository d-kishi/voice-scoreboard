# Task 3.0.1: ビルド実行環境の Windows 移行検証 → 断念

## 目的

WSL2 上での Gradle ビルド（20〜26 分）を高速化するため、Gradle ビルドのみ Windows で実行するハイブリッドアプローチを検証。

## アプローチ

**ハイブリッドビルド**: JS バンドルは WSL2 で事前作成し、Gradle（ネイティブビルド）のみ Windows で実行。

| フェーズ | 担当 | 内容 |
|---------|------|------|
| Phase 0 | ユーザー手動 | JDK 17 + ANDROID_HOME セットアップ |
| Phase 1 | WSL2 Claude Code | JS バンドル事前作成（expo export:embed + hermesc） |
| Phase 2 | Windows Claude Code | Gradle ビルド + APK インストール + 起動 |

## 結果: 断念

Windows 側での Gradle ビルドは完了できず、ハイブリッドアプローチは断念。

## 発生した問題

### 1. Android SDK ツールが Linux バイナリ

M1 で WSL2 の sdkmanager 経由でインストールした SDK ツール（aapt, aidl, cmake, ninja 等）はすべて Linux（ELF）バイナリ。Windows の Gradle がこれらを実行できず `CreateProcess error=216` が発生。

**対処**: Android Studio SDK Manager から Windows 用ツールを追加インストール。

### 2. Windows Claude Code による環境破壊

Windows 側の Claude Code が以下の変更を行い、WSL2 側の開発環境を破壊:

- `package.json` に `lightningcss-win32-x64-msvc` を追加 → lockfile 破損
- `npm install` 実行 → Linux 専用ネイティブバイナリが Windows 用に置換
- `gradlew clean` 実行 → 事前作成した JS バンドルを削除
- `android/build.gradle`, `android/gradle.properties`, `android/app/build.gradle` を変更
- CMake キャッシュ、autolinking キャッシュを削除

### 3. node_modules のクリーンインストールで新たな問題が顕在化

環境復旧のため `rm -rf node_modules && bun install` を実行したところ、`react-native-css-interop@0.2.1` の `babel.js` が `react-native-worklets/plugin` を要求するエラーが発生。

以前の `node_modules` は古いキャッシュ状態で動作していたが、クリーンインストールで依存関係の不整合が顕在化。`react-native-worklets@0.7.4` を追加して解消。

## 根本原因

**WSL2 と Windows で同一ディレクトリを共有する限り、片方の操作がもう片方を壊すリスクが不可避。**

- `node_modules` にはプラットフォーム固有のネイティブバイナリが含まれる
- Windows 側で `npm install` すると Linux バイナリが Windows バイナリに置換される
- Android SDK ツールもプラットフォーム固有のバイナリで構成される
- Claude Code（AI エージェント）は環境の制約を完全に理解できず、自律的に `gradlew clean` や `npm install` を実行してしまう

## 復旧作業

1. Windows 側で変更した Gradle 設定ファイル 3 つを git checkout で復元
2. Windows 側が作成した `fix-build-tools.ps1` を削除
3. `package.json` と `bun.lock` を git checkout で復元
4. `rm -rf node_modules && bun install` でクリーンインストール
5. `react-native-worklets@0.7.4` を追加（`react-native-css-interop` が要求）
6. テスト全パス（5 suites, 86 tests）とバンドル生成成功を確認

## 今後の選択肢

ビルド高速化が必要になった場合の代替案:

| 方法 | 概要 | メリット | デメリット |
|------|------|---------|-----------|
| Windows 専用環境 | Windows 側に独立した node_modules を構築 | Metro + Hot Reload 可能 | ディスク容量倍増、同期管理が必要 |
| WSL2 ネイティブ FS | プロジェクトを WSL2 の ext4 FS に配置 | Gradle 高速化 | Windows ツールとの連携が困難 |
| EAS Build | クラウドビルド | ローカル環境不要 | ネットワーク依存、課金 |
| Gradle キャッシュ最適化 | 2 回目以降のビルド時間短縮 | 追加設定不要 | 初回ビルドは改善しない |

## 変更ファイル

| ファイル | 変更内容 |
|---------|----------|
| `.kiro/specs/voice-scoreboard/tasks.md` | Task 3.0.1 追加 + 断念記録 |
| `package.json` | `react-native-worklets@0.7.4` 追加 |
| `bun.lock` | 上記に伴う lockfile 更新 |
| `docs/02_TaskLog/3.0.1-windows-native-build.md` | 本ファイル（新規作成） |
