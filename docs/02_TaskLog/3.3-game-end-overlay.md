# Task 3.3: 試合終了オーバーレイ

## 実装予測（Plan モードでの分析）
- GameEndOverlay.tsx を新規作成（absolute positioning でスコアエリアのみをオーバーレイ）
- Modal ではなく `StyleSheet.absoluteFill` を使用（ControlBar をディム対象外にするため）
- App.tsx にスコアエリアコンテナ（`<View className="flex-1">`）を新設し、ScorePanel + GameEndOverlay をグループ化
- ScorePanel に `isGameEnd` prop を追加し、`showButtons` で +1/-1 ボタンを条件付きレンダリング
- カードのゴールドグロー: `shadowColor: '#f59e0b'`（iOS）、`elevation: 10`（Android）
- テキストグロー: 既存の `glowStyles.gold` を再利用
- ホイッスル音は SoundService（Task 5.3）未実装のためスキップ
- リスク: NativeWind の `inset-0` 未対応の可能性 → `StyleSheet.absoluteFill` で代替

## 実施内容
- tasks.md 3.3「試合終了オーバーレイ」を実施
- Requirements: 3.3（試合終了表示）, 3.4（操作無効化）, 3.5（リセットのみ許可）, 3.6（リセットからの復帰）
- Contracts: GameEndOverlay
- Task 3.3 完了により Task 3（スコアボード画面の実装）全体が完了

## 実装結果（spec-impl の実際の出力）

### 作成/変更ファイル
| ファイル | 操作 | 内容 |
|---------|------|------|
| `src/features/score/components/GameEndOverlay.tsx` | 新規作成 | 試合終了オーバーレイ（ゴールドカード + ディム背景 + リセットボタン） |
| `src/features/score/components/__tests__/game-end-overlay.test.tsx` | 新規作成 | GameEndOverlay テスト（5件） |
| `src/features/score/components/ScorePanel.tsx` | 変更 | `isGameEnd` prop 追加、ScoreSide に `showButtons` 追加 |
| `src/features/score/components/__tests__/score-panel.test.tsx` | 変更 | 試合終了時のボタン非表示テスト追加（3件） |
| `src/features/score/components/ControlBar.tsx` | 変更 | `testID="control-bar"` 追加 |
| `App.tsx` | 変更 | スコアエリアコンテナ追加、`useScore` 接続、GameEndOverlay 配置 |
| `App.test.tsx` | 変更 | 試合終了オーバーレイ統合テスト追加（5件） |

### 主な技術的決定
- `GameEndOverlay` は `onReset` callback のみ受け取る Presentational コンポーネント
- `StyleSheet.absoluteFill` + NativeWind `absolute inset-0` の併用でスコアエリアのみをカバー
- ディム効果は `bg-black/60`（ResetDialog の `bg-black/50` より濃い。大きなスコア数字に負けないコントラスト）
- カードグロー: iOS は `shadowColor` でゴールド発光、Android は `elevation` + 金色ボーダーで補完
- +1/-1 ボタン非表示は conditional rendering（`{showButtons && ...}`）でツリーから完全除外
- App.tsx で `useScore()` を購読（`isGameEnd` と `reset`）。ScorePanel も内部で `useScore()` を使うが zustand のセレクタにより無駄な再レンダリングなし

## 予測との乖離
| 項目 | 予測 | 実際 | 差異 |
|------|------|------|------|
| オーバーレイ方式 | absolute positioning（Modal 不使用） | `StyleSheet.absoluteFill` + `absolute inset-0` | **一致** |
| スコアエリアコンテナ | `<View className="flex-1">` で ScorePanel + Overlay をグループ化 | 同上 | **一致** |
| ボタン非表示 | ScorePanel に `isGameEnd` prop → ScoreSide に `showButtons` prop | 同上 | **一致** |
| カードグロー | `shadowColor` + `elevation` | 同上 | **一致** |
| テキストグロー | `glowStyles.gold` 再利用 | 同上 | **一致** |
| ControlBar testID | 必要と予測 | `testID="control-bar"` 追加 | **一致** |
| ホイッスル音 | スキップ（Task 5.3/7.2 で対応） | スキップ | **一致** |
| NativeWind `inset-0` | 未対応リスク | 正常動作（NativeWind v4 でサポート済み） | **差異あり**（杞憂だった） |

## 意思決定ログ
| 選択肢 | 採用 | 理由 |
|--------|------|------|
| オーバーレイ: Modal vs absolute positioning | absolute positioning | Modal は全画面を覆い ControlBar もディムになる。design.md の仕様「下部バーはそのまま表示」に反する |
| ディム濃度: bg-black/50 vs bg-black/60 | bg-black/60 | スコア数字が画面高さ 35% と巨大。50% では背景スコアがオーバーレイテキストと競合する |
| ボタン非表示: opacity-0/display:none vs conditional rendering | conditional rendering | 仕様「完全に非表示」を満たす。ツリーから除外されるため testID での `queryAllByTestId` が空配列を返す |
| isGameEnd の取得: ScorePanel 内部で useScore() vs prop で渡す | prop で渡す | ボタン非表示の振る舞いを親から明示的に制御でき、テストで直接 prop を指定可能 |
| App.tsx の useScore 購読 | isGameEnd と reset のみ | zustand のセレクタで最小限の購読。スコア値の変更では App は再レンダリングされない |

## 学び（Lessons Learned）
- NativeWind v4 は `absolute inset-0` を React Native の `position: absolute` + `top/left/right/bottom: 0` に正しく変換する。`StyleSheet.absoluteFill` との併用も問題なし
- Presentational コンポーネントパターン（ResetDialog, GameEndOverlay）は callback props のみでテストが容易。store への直接依存を避けることで単体テストの独立性が保たれる
- App.tsx レベルで `useScore()` を使う場合、zustand のセレクタ購読により必要なフィールドのみの変更でリレンダーが発生する。パフォーマンス上の問題なし
- 既存コンポーネントへの prop 追加は、デフォルト値（`isGameEnd = false`）を設定することで全既存テストの後方互換性を保てる

## テスト結果
- 全 9 スイート / 131 テスト合格
- リグレッションなし
- TDD サイクル: RED → GREEN → VERIFY 完了
