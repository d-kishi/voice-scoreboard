# Implementation Plan

- [x] 1. プロジェクト初期化とスタイリング基盤
- [x] 1.1 Expoプロジェクトの作成と基本設定
  - Expo SDK 52 + TypeScript テンプレートで新規プロジェクト作成
  - 横画面（ランドスケープ）専用に画面方向を固定
  - ESLint / Prettier の設定
  - Jest + React Native Testing Library のテスト環境構築
  - _Requirements: 1.1, 9.5_

- [x] 1.2 NativeWind（Tailwind CSS）の導入とデザイントークン定義
  - NativeWind v4 のインストールと metro.config.js / babel.config.js / global.css の作成
  - tailwind.config.js でビジュアルデザイン仕様のカラーパレットをテーマカラーとして定義（背景: ダークネイビー、スコア数字: 白+グロー、アクセント: シアン/ゴールド、ボタン: ダークグレー、危険: 赤、下部バー: ダークネイビー明るめ）
  - ダークモード背景をデフォルトに設定
  - グロー効果（textShadow）用の共通スタイルユーティリティを用意
  - 動作確認用のサンプル画面でスタイリングが適用されることを検証
  - _Requirements: 1.3_

- [ ] 2. スコア状態管理と試合ルールエンジン
- [x] 2.1 (P) 試合ルール判定の実装
  - 6人制バレーボールの試合終了判定ロジック（25点到達 + 2点差）を純粋関数として実装
  - デュース判定ロジック（24-24以降は2点差がつくまで継続）
  - ルールパラメータ（matchPoint, deuceThreshold, pointGap）を設定可能にし、将来の複数競技対応に備える
  - 境界値テスト: 25-0, 25-23, 25-24（未終了）, 24-24（デュース）, 26-24（終了）, 30-28（長デュース後の終了）等
  - _Requirements: 3.1, 3.2_
  - _Contracts: GameRules Service_

- [x] 2.2 (P) スコア状態管理ストアの実装
  - zustand でスコア状態（左右の得点、試合終了フラグ）を管理するストアを作成
  - zundo（temporal middleware）でundo機能を組み込み、操作履歴を自動管理
  - 得点の加算・減算・リセット操作を提供
  - 試合終了状態ではリセット以外の操作を拒否するガード
  - テスト: 加算/減算/リセットの基本動作、試合終了時のガード、undo による状態復元
  - _Requirements: 2.1, 2.2, 2.3, 2.5, 3.4, 3.5, 3.6_
  - _Contracts: ScoreStore State_

- [x] 2.3 スコア操作hookの実装
  - UIとストアの仲介hook。得点操作時に試合ルール判定を呼び出し、試合終了を自動判定
  - ロールバック（zundo の undo）とリセットの操作を提供
  - undo可能かどうか（canUndo）の状態を公開
  - テスト: 得点加算→試合終了判定の連携、ロールバック後のスコア確認、試合終了状態でのガード
  - 2.1 と 2.2 の成果物を統合
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.4, 3.5, 3.6_
  - _Contracts: useScore Service_

- [ ] 3. スコアボード画面の実装
- [ ] 3.1 左右チームのスコア表示パネル
  - 横画面で左右均等に分割された大きなスコア表示エリアを構築（中央に細い縦の分割線）
  - 各チームの得点を極大サイズ（画面高さの40%程度）の白文字で表示し、textShadow による白色グロー効果を適用
  - +1 / -1 ボタンをダークグレー背景の角丸ボタンとして各スコアの下に横並びで配置
  - useScore hook と接続してリアルタイムにスコアを反映
  - テスト: ボタンタップ時のスコア変更、表示の更新
  - _Requirements: 1.1, 1.2, 2.1, 2.2_
  - _Contracts: ScorePanel_

- [ ] 3.2 操作バーとリセット確認ダイアログ
  - 画面下端に固定する操作バーを構築
  - 左側: 「音声入力」「読み上げ」トグルボタン（有効時はシアン背景、マイク/スピーカーアイコン + ラベル付き）
  - 右側: 「ロールバック」「リセット」ボタン（ダークグレー背景、ボーダー付き、リフレッシュ系アイコン + ラベル）
  - リセットボタンタップ時に確認ダイアログを表示（ダークネイビー背景のカードに角丸・薄いグレーボーダー、タイトル「リセット確認」、説明文「スコアを 0-0 にリセットしますか？」、「キャンセル」グレーボタン、「リセット」赤ボタン）
  - 背景にディム + ブラー効果を適用
  - undo不可時はロールバックボタンを無効化
  - テスト: ダイアログ表示・承認・キャンセル、ロールバックの動作
  - _Requirements: 2.3, 2.4, 2.5_
  - _Contracts: ControlBar, ResetDialog_

- [ ] 3.3 試合終了オーバーレイ
  - 試合終了判定時にゴールド/アンバーの枠線付きカード（角丸、中央配置）をオーバーレイとして表示
  - 枠線にゴールドの発光/グロー効果を適用
  - 「試合終了」テキストをゴールド/アンバーで大きめ太字表示
  - オーバーレイ内にリセットボタン（ゴールド/アンバー背景、白文字）のみ表示
  - +1 / -1 ボタンは非表示にする（無効化ではなく完全に非表示）
  - 背景スコアをディム表示（暗転）にする。下部バーはそのまま表示
  - リセット実行で0-0に戻し新しい試合を開始可能に
  - テスト: 試合終了状態でのオーバーレイ表示、+1/-1ボタンの非表示確認、リセット後のオーバーレイ非表示
  - _Requirements: 3.3, 3.4, 3.5, 3.6_
  - _Contracts: GameEndOverlay_

- [ ] 4. 設定管理と画面スリープ防止
- [ ] 4.1 (P) 設定ストアと永続化
  - zustand + persist ミドルウェアで音声認識ON/OFF、読み上げON/OFFの設定を管理
  - AsyncStorage による永続化で次回起動時に設定を復元
  - ハイドレーション完了を検知し、設定復元後にアプリを初期化
  - テスト: 設定変更の永続化、アプリ再起動時の復元
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_
  - _Contracts: SettingsStore State_

- [ ] 4.2 (P) 画面スリープ防止の組み込み
  - expo-keep-awake をメイン画面に組み込み、フォアグラウンド中は画面常時点灯
  - テスト: useKeepAwake hook が正しく呼ばれることの確認
  - _Requirements: 7.1_

- [ ] 5. 音声サービス層の実装
- [ ] 5.1 (P) 音声認識サービスの実装
  - expo-speech-recognition のラッパーサービスを作成
  - ウェイクワード検出モード: 単発認識 + end イベントでの再起動ループ
  - コマンド認識モード: contextualStrings（「右」「左」「ロールバック」「リセット」）を設定し認識精度を向上
  - Android向けの androidIntentOptions（無音判定時間の制御）を設定
  - マイク権限の要求・状態管理
  - テスト: モード切替、認識結果のコールバック呼び出し、権限リクエスト
  - _Requirements: 4.1, 4.2, 5.1, 5.2, 5.3, 5.4, 9.4_
  - _Contracts: SpeechRecognitionService Service_

- [ ] 5.2 (P) 音声読み上げサービスの実装
  - expo-speech のラッパーサービスを作成
  - 日本語（ja-JP）で「Ready」「Roger」およびスコア（「左{点数} 右{点数}」）を読み上げ
  - 読み上げ完了コールバックで次の処理への遷移を通知
  - テスト: 読み上げ開始/完了コールバック、isSpeaking状態の管理
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_
  - _Contracts: SpeechSynthesisService Service_

- [ ] 5.3 (P) 効果音再生サービスの実装
  - expo-av でホイッスル音の効果音再生サービスを作成
  - アプリ起動時にサウンドアセットをプリロード
  - 試合終了時に5秒間のホイッスル音を再生
  - テスト: プリロード、再生開始/完了
  - _Requirements: 6.6_
  - _Contracts: SoundService Service_

- [ ] 6. 音声状態マシンの実装
- [ ] 6.1 K.I.T.T.スタイル音声状態マシンの構築
  - IDLE → SPEAKING_READY → LISTENING → SPEAKING_ROGER → EXECUTING → SPEAKING_SCORE → IDLE の状態遷移を管理するhookを実装
  - 音声認識と読み上げの排他制御: 読み上げ中は認識を停止し、完了後に再開
  - IDLE状態での常時リスニング（ウェイクワード「スコア」検知→Ready応答）
  - LISTENING状態での3秒カウントダウンとタイムアウトによるIDLE復帰
  - コマンド（「右」「左」「ロールバック」「リセット」）の判定とスコア操作の実行
  - ロールバック/リセット実行後のスコア読み上げ（「左{点数} 右{点数}」形式）
  - 得点加算時はRogerのみ応答しスコア読み上げなし
  - 設定（音声認識ON/OFF、読み上げON/OFF）の反映
  - テスト: 各状態遷移パターン、タイムアウト、排他制御、設定反映
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 5.1, 5.2, 5.3, 5.4, 5.5, 6.1, 6.2, 6.3, 6.4, 6.5, 8.3, 8.4_
  - _Contracts: useVoiceStateMachine State_

- [ ] 7. 音声UI統合
- [ ] 7.1 LISTENING状態のオーバーレイ表示
  - LISTENING状態に入った時に画面中央にシアンの同心円発光リング（グラデーション）とマイクアイコン（白）を表示
  - リングの下に「Ready」テキスト（シアン）を表示
  - 「Ready」の下に秒数カウントダウン（例: `1s`）を白またはグレーで表示
  - 背景のスコア・ボタンにブラー（blur）+ ディム（暗転）を適用。下部バーはそのまま表示
  - テスト: 状態に応じたオーバーレイの表示/非表示、カウントダウンの表示
  - _Requirements: 4.3, 4.4_
  - _Contracts: ListeningOverlay_

- [ ] 7.2 試合終了時のホイッスル音連携
  - 試合終了判定時に効果音再生サービスを呼び出してホイッスル音を5秒間再生
  - 試合終了オーバーレイとサウンド再生の同期
  - タッチ操作・音声操作の両方で試合終了時に発動することを確認
  - テスト: 試合終了トリガーからホイッスル音再生までの連携
  - _Requirements: 3.3, 6.6_

- [ ] 7.3 音声状態マシンとUI全体の統合
  - メイン画面にuseVoiceStateMachine hookを接続
  - 音声コマンドによるスコア操作がリアルタイムに画面へ反映されることを確認
  - タッチ操作時は音声読み上げを行わないことを確認
  - 音声認識OFF時のフォールバック（タッチ操作のみモード）
  - マイク権限未許可時のUI通知と設定画面誘導
  - テスト: 音声コマンド→スコア変更→画面更新の一連フロー、設定トグルの反映
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 6.5, 8.3, 8.4, 9.2, 9.4_

- [ ] 8. パフォーマンス最適化と最終検証
- [ ] 8.1 起動パフォーマンスとオフライン動作の検証
  - アプリ起動が3秒以内に完了することを検証
  - expo-keep-awake と zustand ハイドレーションの初期化を並列実行して起動を高速化
  - ネットワーク接続なし（機内モード）での全機能動作を検証
  - 音声認識のオンデバイスモデルがオフラインで利用可能か確認
  - _Requirements: 9.1, 9.2, 9.3_

- [ ] 8.2 プラットフォーム互換性の確認
  - iOS 14.0以上とAndroid 10以上での動作検証
  - Android固有の音声認識タイムアウト（再起動ループ）の実機確認
  - マイク権限フローのプラットフォーム差異を確認
  - _Requirements: 9.4, 9.5_
